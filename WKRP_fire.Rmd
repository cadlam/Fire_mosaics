---
title: "WKRP_fire"
author: "Chris Adlam"
date: "11/15/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load scripts
```{r include = F}
source("scripts/data_load.R") #contains packages to load
source("scripts/splist2presabs.R") #function for going from species list to presence/absence
source("scripts/pairwise_permanova.R")
```

# Habitat clustering
## PERMANOVA
### Main Permanova (plants)
* Just using LS/UN/HS to show that LS and UN can be lumped together.
* Main PERMANOVA shows that there is an effect of sev and of tsf (in categories).

```{r echo = F}
### Is there an effect of sev and time since fire (using categories)? Yes for sev, no for tsf


#### Worth checking: there was an effect of tsf and an interaction using all plots incl. mult and Rx

# using on sites between 5 and 20 years old (and UN)

comp.data <- plant_dat_pa_w %>%  #filter(sev %in% c("l", "h", "u"))
    filter((tsf < 25 & tsf > 4) | sev == "u")

comp.sub <- subset(comp.data, select = ACMA:WHMO)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))
attach(comp.env)

kable(adonis2(log1p(comp.sub) ~ sev * tsf_cat, permutations = 9999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() # note: without log1p transformation, there is no significant interaction



#all spp
comp.data <- all_spp_dat_w %>%  #filter(sev %in% c("l", "h", "u"))
  filter((tsf < 25 & tsf > 4) | sev == "u")# %>%
#  filter((sev == "multiple" & tree_cov > 45) | sev != "multiple")
  
comp.sub <- subset(comp.data, select = ACMA:YRWA)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))
attach(comp.env)

kable(adonis2(log1p(comp.sub) ~ sev * tsf_cat, permutations = 9999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() 
```

### Pairwise PERMANOVA
* There is not a statistically significant difference between LS and UN sites, but all other categories are different. UDATE: actually now (a few small changes), HS and MULT are not different.
```{r eval = F, include = F}
## Pairwise PERMANOVA function (run)
# 1 = High severity; 2 = Low severity; 3 = Unburnt.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

comp.data <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair <- pairwise.adonis(log1p(comp.sub), comp.data$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

kable(pair, caption = "Table 2: pairwise PERMANOVA results", digits = 4) %>%
  kable_styling()

```

## MRPP
* MRPP instead of PERMANOVA?
```{r echo = F}
library(devtools)
install_github("nsahr/gMRPP")
library(gMRPP)

gmrpp(mrpp_data, mrpp_cat)

str(mrpp_cat)
str(mrpp_data)

names(mrpp_data)[1] <- "ID"
names(mrpp_cat)[1] <- "ID"
names(mrpp_cat)[2] <- "grp"




#plants
# seems to work better with cov than pa (no convergence)
mrpp_data <- plant_dat_pa_w %>% # [,c(2:82)]
#  filter(sev %in% c("l","h", "u")) %>% 
  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
  dplyr::select(ACMA:WHMO) %>% 
  dplyr::select(which(colSums(.) > 0)) 

mrpp_cat <- plant_dat_pa_w %>% 
#  filter(sev %in% c("l","h", "u")) %>% 
  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
#  select(site_id, sev)
  dplyr::select(sev)
  
mrpp_cat$sev <- as.factor(mrpp_cat$sev)
  
plant.mrpp <- mrpp(mrpp_data, mrpp_cat)
str(plant.mrpp)


# Save and change plotting parameters
def.par <- par(no.readonly = TRUE)
layout(matrix(1:2,nr=1))

plot(plant.ord <- metaMDS(sqrt(mrpp_data), type="text", display="sites"))
ordihull(plant.ord, mrpp_cat, label = T)

with(plant.mrpp, {
  fig.dist <- hist(boot.deltas, xlim=range(c(delta,boot.deltas)), 
                 main="Test of Differences Among Groups")
  abline(v=delta); 
  text(delta, 2*mean(fig.dist$counts), adj = -0.5,
     expression(bold(delta)), cex=1.5 )  }
)
par(def.par)


## meandist 
# calculates a matrix of mean within-cluster dissimilarities (diagonal) and between-cluster dissimilarities (off-diagonal elements)
plant.md <- meandist(vegdist(mrpp_data, mrpp_cat, method = "raup")) # Need to adjust the columns to only keep species.... should fix this
plant.md
summary(plant.md)
plot(plant.md)

str(mrpp_cat)











#plants
# seems to work better with cov than pa (no convergence)
mrpp_data <- all_spp_dat_w %>% # [,c(2:82)]
#  filter(sev %in% c("l","h", "u")) %>% 
  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
  dplyr::select(ABPR:YRWA) %>% 
  dplyr::select(which(colSums(.) > 0)) 

mrpp_cat <- all_spp_dat_w %>% 
#  filter(sev %in% c("l","h", "u")) %>% 
  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
#  select(site_id, sev)
  dplyr::select(sev)
  
mrpp_cat$sev <- as.factor(mrpp_cat$sev)
  
plant.mrpp <- mrpp(mrpp_data, mrpp_cat)
summary(plant.mrpp)


# Save and change plotting parameters
def.par <- par(no.readonly = TRUE)
layout(matrix(1:2,nr=1))

plot(plant.ord <- metaMDS(sqrt(mrpp_data), type="text", display="sites"))
ordihull(plant.ord, mrpp_cat, label = T)

with(plant.mrpp, {
  fig.dist <- hist(boot.deltas, xlim=range(c(delta,boot.deltas)), 
                 main="Test of Differences Among Groups")
  abline(v=delta); 
  text(delta, 2*mean(fig.dist$counts), adj = -0.5,
     expression(bold(delta)), cex=1.5 )  }
)
par(def.par)


## meandist 
# calculates a matrix of mean within-cluster dissimilarities (diagonal) and between-cluster dissimilarities (off-diagonal elements)
plant.md <- meandist(vegdist(mrpp_data, mrpp_cat, binary = T, method ="raup")) # Need to adjust the columns to only keep species.... should fix this
plant.md
summary(plant.md)
plot(plant.md)


```

# Alpha, Beta, Gamma div.

#### Species number vs TSF plots
```{r}

plant_div2 <- plant_div %>%  # see below
  filter(tsf < 25 & tsf > 4)

ggplot(plant_div2, aes(x=tsf, y=simpson)) +
  geom_point(aes(colour=sev)) +
  geom_smooth(aes(colour=sev), method = "lm")

all_spp_div2 <-all_spp_div %>% 
  filter(tsf < 25 & tsf > 4)

ggplot(all_spp_div2, aes(x=tsf, y=simpson)) +
  geom_point(aes(colour=sev)) +
  geom_smooth(aes(colour=sev), method = "lm")

bird_div2 <-bird_div %>% 
  filter(tsf < 25)

ggplot(bird_div2, aes(x=tsf, y=simpson)) +
  geom_point(aes(colour=sev)) +
  geom_smooth(aes(colour=sev), method = "lm")

```


#### All species
* Diversity is highest in RX (?), lowest in UN. HS is lower than mult/LS.
* Combining LS/UN and Rx/MULT, managed sites have higher diversity; HS and LS/UN are lower and about equal.

```{r}
# Number of occurrences of all species
all_spp_dat_l %>% 
  group_by(species) %>% 
  summarise(sums=sum(pa))

#same thing, per sev type
all_spp_dat_l %>%
  filter(pa != 0) %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::count(species, sev3, sort = TRUE)

df <- all_spp_dat_l %>%
#  filter(pa != 0) %>% 
  add_count(species)


# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
richA <- ddply(all_spp_w_pa,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

# Shannon diversity
shanA <- ddply(all_spp_w_pa,~site_id,function(x) {
        data.frame(shannon=diversity(x[-1], index="shannon"))
})

#Simpson diversity
simpA <- ddply(all_spp_w_pa,~site_id,function(x) {
        data.frame(simpson=diversity(x[-1], index="simpson"))
})

#put it together (note names changed!)
all_spp_div <- merge(all_spp_richness, all_spp_shannon, by = "site_id") %>%
  merge(., all_spp_simpson, by = "site_id") %>% 
  merge(., site_data, by = "site_id")

#all_spp_div  %>%
#  group_by(sev) %>%
#  summarise_all(mean, na.rm=TRUE)

all_spp_div$cov_cat <- as.factor(all_spp_div$cov_cat) 

all_spp_div1 <- all_spp_div %>%   
    mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev))

#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev == "Rx" | sev == "multiple", "manag", sev)))

p7 <- ggplot(all_spp_div1, aes(x = sev3, y = richness)) +
  geom_boxplot() +
  ggtitle("All species richness") +
  xlab("Habitat")  +
  theme_cowplot(12)

p8 <- ggplot(all_spp_div1, aes(x = sev3, y = shannon)) +
  geom_boxplot()  +
  ggtitle("All species Shannon") +
  xlab("Habitat")  +
  theme_cowplot(12)

p9 <- ggplot(all_spp_div1, aes(x = sev3, y = simpson)) +
  geom_boxplot()  +
  ggtitle("All species Simpson") +
  xlab("Habitat")  +
  theme_cowplot(12)

# do anovas to test differences?
```

#### Plants only
*Div highest, in mnanag; lowest in LS/UN, intermediate in HS.
* Similar to all_spp analysis, LS is acutally comparable to HS in diversity when separated from UN.

```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
plant_richness <- ddply(plant_mat_pa_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

# Shannon diversity
plant_shannon <- ddply(plant_mat_pa_w,~site_id,function(x) {
        data.frame(shannon=diversity(x[-1], index="shannon"))
})

plant_simpson <- ddply(plant_mat_pa_w,~site_id,function(x) {
        data.frame(simpson=diversity(x[-1], index="simpson"))
})

#put it together
plant_div <- merge(plant_richness, plant_shannon, by = "site_id") %>%
  merge(., plant_simpson, by = "site_id") %>% 
  merge(., site_data, by = "site_id")

#all_spp_div  %>%
#  group_by(sev) %>%
#  summarise_all(mean, na.rm=TRUE)

plant_div$cov_cat <- as.factor(plant_div$cov_cat) 

plant_div1 <- plant_div %>%   
    mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev))
  
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev == "Rx" | sev == "multiple", "manag", sev)))

ggplot(plant_div1, aes(x = sev3, y = richness)) +
  geom_boxplot()  +
  ggtitle("Plant richness") +
  xlab("Habitat")  +
  theme_cowplot(12)

ggplot(plant_div1, aes(x = sev3, y = shannon)) +
  geom_boxplot() +
  ggtitle("Plant Shannon") +
  xlab("Habitat")  +
  theme_cowplot(12)

ggplot(plant_div1, aes(x = sev3, y = simpson)) +
  geom_boxplot()  +
  ggtitle("Plant Simpson") +
  xlab("Habitat")  +
  theme_cowplot(12)

# do anovas to test differences?
```

#### Birds only
* div about equal in HS and UN/LS, but higher in manag.
* Interstingly, Rx is still highest when separating all categories, similar to plants.

```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
bird_richness <- ddply(bird_mat_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

# Shannon diversity
bird_shannon <- ddply(bird_mat_w,~site_id,function(x) {
        data.frame(shannon=diversity(x[-1], index="shannon"))
})

bird_simpson <- ddply(bird_mat_w,~site_id,function(x) {
        data.frame(simpson=diversity(x[-1], index="simpson"))
})

#put it together
bird_div <- merge(bird_richness, bird_shannon, by = "site_id") %>%
  merge(., bird_simpson, by = "site_id") %>% 
  merge(., site_data, by = "site_id")

#all_spp_div  %>%
#  group_by(sev) %>%
#  summarise_all(mean, na.rm=TRUE)

bird_div$cov_cat <- as.factor(bird_div$cov_cat) 

bird_div1 <- bird_div %>%   
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev))

#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev == "Rx" | sev == "multiple", "manag", sev)))

ggplot(bird_div1, aes(x = sev3, y = richness)) +
  geom_boxplot() +
  ggtitle("Bird richness") +
  xlab("Habitat")  +
  theme_cowplot(12)

ggplot(bird_div1, aes(x = sev3, y = shannon)) +
  geom_boxplot() +
  ggtitle("Bird Shannon") +
  xlab("Habitat")  +
  theme_cowplot(12)

ggplot(bird_div1, aes(x = sev3, y = simpson)) +
  geom_boxplot() +
  ggtitle("Bird Simpson") +
  xlab("Habitat")  +
  theme_cowplot(12)

# do anovas to test differences?
```

#### Lichens only
*Predictably, lichens are less diverse in HS stands and most in UN/LS, but manag is pretty close.

```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
lichen_richness <- ddply(lichen_mat_genus_pa_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

# Shannon diversity
lichen_shannon <- ddply(lichen_mat_genus_pa_w,~site_id,function(x) {
        data.frame(shannon=diversity(x[-1], index="shannon"))
})

lichen_simpson <- ddply(lichen_mat_genus_pa_w,~site_id,function(x) {
        data.frame(simpson=diversity(x[-1], index="simpson"))
})

#put it together
lichen_div <- merge(lichen_richness, lichen_shannon, by = "site_id") %>%
  merge(., lichen_simpson, by = "site_id") %>% 
  merge(., site_data, by = "site_id")

#all_spp_div  %>%
#  group_by(sev) %>%
#  summarise_all(mean, na.rm=TRUE)

lichen_div$cov_cat <- as.factor(lichen_div$cov_cat) 

lichen_div1 <- lichen_div %>%   
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev))


#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev == "Rx" | sev == "multiple", "manag", sev)))

ggplot(lichen_div1, aes(x = sev3, y = richness)) +
  geom_boxplot() +
  ggtitle("Lichen richness") +
  xlab("Habitat")  +
  theme_cowplot(12)

ggplot(lichen_div1, aes(x = sev3, y = shannon)) +
  geom_boxplot() +
  ggtitle("Lichen Shannon") +
  xlab("Habitat")  +
  theme_cowplot(12)

ggplot(lichen_div1, aes(x = sev3, y = simpson)) +
  geom_boxplot()  +
  ggtitle("Lichen Simpson") +
  xlab("Habitat")  +
  theme_cowplot(12)

# do anovas to test differences?
```

## Alpha, Beta,Gamma diversity calculation
```{r}

# Number of occurrences of all species
#Plants
#gamma.matrix <- all_spp_dat_w %>% 
#  dplyr::select(c(sev, ABCO:YRWA)) %>% 
  
#birds
gamma.matrix <- bird_dat_w %>%   
  dplyr::select(c(sev, ACWO:YRWA)) %>% 
  
#ALL SPP
  
  
gamma.matrix <- all_spp_dat_w %>% 
  dplyr::select(c(sev, ABCO:YRWA)) %>% 
  

#Plants
gamma.matrix <- plant_dat_pa_w %>% 
  dplyr::select(c(sev, ABCO:YAMI)) %>% 
  group_by(sev) %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  group_by(sev3) %>% 
  dplyr::select(-sev) %>% 
  summarise_all(sum)

gamma.attr = gamma.matrix %>% dplyr::select(sev3)
gamma.abund = gamma.matrix %>% dplyr::select(-sev3) 

richG = specnumber(gamma.abund)
shanG = exp(diversity(gamma.abund, index = "shannon"))
simpG = diversity(gamma.abund, index = "invsimpson")

gamma.stats = data.frame(gamma.attr, richG, shanG, simpG)




gamma.matrix <- plant_dat_pa_w %>% 
  dplyr::select(c(sev, ABCO:YAMI)) %>% 
  group_by(sev) %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  group_by(sev3) %>% 
  dplyr::select(-sev)

str(comp.abund)




#All SPP
comp.attr = all_spp_dat_w %>% dplyr::select(site_id)
comp.abund = all_spp_dat_w %>% dplyr::select(c(ABCO:YRWA)) 

#Birds
comp.attr = bird_dat_w %>% dplyr::select(site_id)
comp.abund <- bird_dat_w %>% dplyr::select(c(ACWO:YRWA))


#Plants
#need to use gamma.matrix and add site id back in and get rid of sev3
gamma.matrix <- plant_dat_pa_w %>% 
  dplyr::select(c(site_id, ABCO:YAMI)) %>% 
  group_by(site_id)

comp.attr = plant_dat_pa_w %>% dplyr::select(site_id)
comp.abund <- gamma.matrix %>% ungroup() %>% dplyr::select(c(ABCO:YAMI))

comp.abund = plant_dat_cov_w %>% dplyr::select(c(ABCO:YAMI)) 


richA = specnumber(comp.abund)
#shanA = exp(diversity(comp.abund, index = "shannon")) # not working
shanA <- diversityresult(x = comp.abund, y= NULL, index="Shannon", method = "each site", sortit = FALSE)
#simpA = diversity(comp.abund, index = "invsimpson")
simpA = -(1/(diversityresult(x = comp.abund, y= NULL, index="Simpson", method = "each site", sortit = FALSE) - 1)) # for some reason I coudn't get the direct calculation of inverse Simpson to work, but this seems to do the trick
# Actually not a mistake....... WHY is inverse simpson the same as richness? 






richA = specnumber(comp.abund)
shanA = exp(diversity(comp.abund, index = "shannon"))
simpA = diversity(comp.abund, index = "invsimpson")

alpha.stats = data.frame(comp.attr, richA, shanA, simpA)

names(alpha.stats)[2] <- "richA"
names(alpha.stats)[3] <- "shanA"
names(alpha.stats)[4] <- "simpA"

alldiv = left_join(alpha.stats, site_data, by = "site_id") %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  left_join(gamma.stats) %>% 
  mutate(richB = richG / richA,
         shanB = shanG / shanA,
         simpB = simpG / simpA) 

```


## Beta Diversity (binomial)
```{r}
# Code from Jonah

beta <- function(df){
  
  tempdf = df %>% dplyr::select(-sev3)
  
  dis = c(vegdist(tempdf, method = "binomial", binary = "true", na.rm = TRUE))
  
  result = data.frame(sev3 = rep(unique(df$sev3), length = length(dis)),
#                      year = rep(unique(df$year), length = length(dis)),
                      dis = dis)
  
}


#all spp
comptable <-  all_spp_w_pa %>% full_join(site_data[, c("site_id", "sev")], by = "site_id") %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% dplyr::select(-c(site_id, sev))

bj_output_all = comptable %>% group_by(sev3) %>% do(beta(.))

beta_all <- bj_output_all %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("All spp Pairwise Beta Div. (binomial)")   +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)


#birds
comptable <-  bird_dat_w %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ACWO:YRWA)) %>% 
  dplyr::select(-V1) #puttig together the plot id and sev and joinign wide format data then dropping site id

bj_output_birds = comptable %>% group_by(sev3) %>% do(beta(.))

beta_birds <- bj_output_birds %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Bird Pairwise Beta Div. (binomial)")   +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)


#plants (cov)
#remember to alter above function to use jaccard instead of binomial (and binary = false)
comptable <-  plant_dat_cov_w %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ABCO:YAMI)) 

bj_output_plants_cov = comptable %>% group_by(sev3) %>% do(beta(.))

beta_plants_cov <- bj_output_plants_cov %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Plant Pairwise Beta Div. (jaccard)")   +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

#plants (pa)
comptable <-  plant_dat_pa_w %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ABCO:YAMI)) 

bj_output_plants_pa = comptable %>% group_by(sev3) %>% do(beta(.))

beta_plants_pa <- bj_output_plants_pa %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Plant Pairwise Beta Div. (binomial)")   +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

#lichens (pa)
comptable <-  lichen_dat_genus_pa_w %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, Ahtiana:Xanthomendoza)) %>% 
  dplyr::select(-Dummy)

bj_output_lichens = comptable %>% group_by(sev3) %>% do(beta(.))

beta_lichen_pa <- bj_output_lichens %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Lichen Pairwise Beta Div. (binomial)")   +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

# Putting plots together
grid.arrange(beta_all, beta_birds, beta_plants_pa, beta_lichen_pa, nrow = 2)
```

#Alpha diversity figures
```{r, "alpha Diversity"}
p7 <- alldiv %>% 
  ggplot(aes(x = sev3, y = richA,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) +
  ggtitle("Alpha-Level Richness")+
  ylab("Species Richness")  +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none") + theme(aspect.ratio=1)

p8 <- alldiv %>% ggplot(aes(x = sev3,
                      y = shanA,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~tsf_cat) +
  ggtitle("Alpha-Level Exp. Shannon")+
  ylab("Exp. Shannon Diversity Index")  +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p9 <- alldiv %>% ggplot(aes(x = sev3,
                      y = simpA,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) + 
  ggtitle("Alpha-Level Inv. Simpson") +
  ylab("Inv. Simpson Diversity Index") +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

grid.arrange(p7, p8, p9, nrow = 1)


```

#Gamma diversity figures
```{r, "Gamma Diversity"}
p1 <- alldiv %>% 
  ggplot(aes(x = sev3, y = richG,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
#  facet_wrap(~year) +
  ggtitle("Gamma-Level Richness")+
  ylab("Species Richness")  +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none") + theme(aspect.ratio=1)

p2 <- alldiv %>% ggplot(aes(x = sev3,
                      y = shanG,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
#  facet_wrap(~tsf_cat) +
  ggtitle("Gamma-Level Exp. Shannon")+
  ylab("Exp. Shannon Diversity Index")  +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p3 <- alldiv %>% ggplot(aes(x = sev3,
                      y = simpG,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
#  facet_wrap(~year) + 
  ggtitle("Gamma-Level Inv. Simpson") +
  ylab("Inv. Simpson Diversity Index") +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

grid.arrange(p1, p2, p3, nrow = 1)
```

# Beta diversity figures
```{r, "Beta Diversity"}
p4 <- alldiv %>% ggplot(aes(x = sev3,
                      y = richB,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) +
  ggtitle("Beta-Level Richness")+
  ylab("Species Richness")  +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p5 <- alldiv %>% ggplot(aes(x = sev3,
                      y = shanB,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) +
  ggtitle("Beta-Level Exp. Shannon")+
  ylab("Exp. Shannon Diversity Index")  +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p6 <- alldiv %>% ggplot(aes(x = sev3,
                      y = simpB,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) + 
  ggtitle("Beta-Level Inv. Simpson") +
  ylab("Inv. Simpson Diversity Index")  +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

grid.arrange(p4, p5, p6, nrow = 1)
```

# Calculating Statistical Differences Between Groups:

## Alpha Diversity
```{r}
# Writing a simple model

# Calling packages
library(lme4); library(lmerTest); library(emmeans)

# Setting our predictors to factors
alldiv$sev <- as.factor(alldiv$sev)
#alldiv$year <- as.factor(alldiv$year)

# Fitting an interactive model and an additive model
mod_int = lmer(richA ~ sev + (1|site_id), data = alldiv)
#mod_add = lmer(richA ~ sev + (1|Regen_ID), data = alldiv)

# Are these two models significantly different from one another? Look for a p < .05
# (Likelihood ratio test)
anova(mod_add, mod_int)

# What's the model ANOVA table
anova(mod_add)

# capture.output(anova(mod_add),file="alpha_rich_anova")

# Estimated means between groups within each year
means = emmeans(mod_add, specs = "OBS_FIRE_SEV", by = "year", adjust = "tukey")

# All pairwise comparisons
paircomp = pairs(means)

# Assigning labels to each groups
CLD(means)

#create dataframe to use for labeling richness boxplots
alpha_rich_stats <- as.data.frame(CLD(means))
```

##Shannon

```{r}
#shannon

# Fitting an interactive model and an additive model
mod_int_shan = lmer(shanA ~ OBS_FIRE_SEV + year + OBS_FIRE_SEV:year + (1|Regen_ID), data = alldiv)
mod_add_shan = lmer(shanA ~ OBS_FIRE_SEV + year + (1|Regen_ID), data = alldiv)

# Are these two models significantly different from one another? Look for a p < .05
# (Likelihood ratio test)
anova(mod_add_shan, mod_int_shan)

# What's the model ANOVA table - interaction one has lower AIC
anova(mod_int_shan)
summary(mod_int_shan)
# capture.output(anova(mod_int_shan),file="alpha_shan_anova")

# Estimated means between groups within each year
means_shan = emmeans(mod_int_shan, specs = "OBS_FIRE_SEV", by = "year", adjust = "tukey")

# All pairwise comparisons
paircomp_shan = pairs(means_shan)

# Assigning labels to each groups
CLD(means_shan)

#create dataframe to use for labeling shannon boxplots
alpha_shan_stats <- as.data.frame(CLD(means_shan))

```

##Simpsons

```{r}
#simpsons

# Fitting an interactive model and an additive model
mod_int_simp = lmer(simpA ~ OBS_FIRE_SEV + year + OBS_FIRE_SEV:year + (1|Regen_ID), data = alldiv)
mod_add_simp = lmer(simpA ~ OBS_FIRE_SEV + year + (1|Regen_ID), data = alldiv)

# Are these two models significantly different from one another? Look for a p < .05
# (Likelihood ratio test)
anova(mod_add_simp, mod_int_simp)

# What's the model ANOVA table - interaction one has lower AIC
anova(mod_int_simp)

# capture.output(anova(mod_int_simp),file="alpha_simp_anova")

# Estimated means between groups within each year
means_simp = emmeans(mod_int_simp, specs = "OBS_FIRE_SEV", by = "year", adjust = "tukey")

# All pairwise comparisons
paircomp_simp = pairs(means_simp)

# Assigning labels to each groups
CLD(means_simp)

#create dataframe to use for labeling shannon boxplots
alpha_simp_stats <- as.data.frame(CLD(means_simp))

```


# Indicator species analysis for plants (HS vs LS/UN)
* Doesn't turn up many species and fails to return anything when Mult and Rx are included

```{r echo = F}
### Community data matrix
plant_data_filtered <- plant_dat_pa_l %>% 
#  select(-DUMB) %>% 
  left_join(., site_data, by = "site_id") %>% 
  filter(sev %in% c("l", "h", "u")) 

plant_dat <- left_join(plant_data_filtered, plant_names, by = "species") %>%
  mutate(sev2 = ifelse(sev == 'h' , "h", "lu")) 

plant_dat_select  <- plant_dat %>%
  dplyr::select(site_id, species, pa, sev, sev_tsf, sev2)

plant_matrix1 <- spread(data = plant_dat_select, key = species, value = pa, fill = 0)

# getting rid of species detected in 0 plots (for some reason there appears to be no cover recorded for ALRH and CESA, but they were both found at only one plot so no big deal)
plant_matrix1 <- plant_matrix1 %>% 
  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))

plant_matrix1 <- plant_matrix1[, (plant_matrix1[57, ]) > 0]
plant_matrix1 <- plant_matrix1[-57, ]


### Vector for site classification
### severity
data <- plant_matrix1[,-c(1:4)]
groups1 <- as.vector(plant_matrix1$sev2)

#groups1 = as.vector(plant_dat$tsf_cat2)
#groups1 = as.vector(plant_dat$sev_tsf)

Indval_out1 <- indval(data, groups1, numitr=10000)
gr <- Indval_out1$maxcls[Indval_out1$pval<=0.05]
iv <- Indval_out1$indcls[Indval_out1$pval<=0.05]
pv <- Indval_out1$pval[Indval_out1$pval<=0.05]
fr <- apply(data>0, 2, sum)[Indval_out1$pval<=0.05]
indvalsummary <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
indvalsummary1 <- indvalsummary[order(indvalsummary$group, -indvalsummary$indval),]
prob.corrected1 = p.adjust(Indval_out1$pval, "BH") # correct p.value for multiple testing
#kable(indvalsummary1)

indvalsummary1 <- cbind(rownames(indvalsummary1), data.frame(indvalsummary1, row.names=NULL))

names(indvalsummary1)[1]<-"species"

indval <- left_join(indvalsummary1, plant_names, by = "species") %>% 
  mutate(HS_ind = ifelse(is.na(full_name), species, full_name)) %>% 
  dplyr::select(HS_ind, group, indval, pvalue) %>% 
  mutate("Indicator value" = indval * 100) %>% 
  filter(indval >= 0.25) %>% 
  filter(pvalue < 0.05)

indval_hs <- indval %>% 
  filter(group =="1") %>% 
  dplyr::select(HS_ind, "Indicator value")

indval_ls <- indval %>% 
  filter(group =="2")%>% 
  dplyr::select(HS_ind, "Indicator value")

names(indval_hs)[1]<-"Indicators of HS"
names(indval_ls)[1]<-"Indicators of LS/UN"


#names(spp_diff2)[1]<-"Species found only in LS/UN"
indval_table <- list(indval_hs, indval_ls)

kable(indval_table, caption = "Table 3: Indicator species for different habitats (HS vs LS/UN)", digits = 0) %>%
  kable_styling()

#write.csv(indvalsummary1, file = "indvalsummary1.csv")
#write.csv(prob.corrected1, file = "prob.corrected1.csv")
```

# Species frequency of occurrence in each habitat
* Looking at the fequency of occurrence of all plants detected at least 5 times (114 species), it appears that most species that have a preference for UN/LS or HS are also found in MANAG sites: 20/27 species found at least 2x more frequently in UNLS as in HS are also found at least 2x more frequently in mult or Rx than HS. Conversely, 38/42 species that are at least 2x as frequent in HS as in UNLS are also 2x as frequent in either mult or Rx as in UN/LS.
*Kruskall-Wallis rank test?
```{r}
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type
plant_mat_UNLS <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "u" | sev == "l") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_HS <- plant_mat_pa_w %>% 
  left_join(site_data, by = "site_id") %>% 
  filter(sev=="h") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MANAG <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "multiple" | sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MULT <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "multiple") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_Rx <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

#Getting the number of detections for each species
plant_dat_sum_HS <- rbind(plant_mat_HS[,-1], colSums(plant_mat_HS[-1,-1]))
plant_sum_HS <- data.frame(t(tail(plant_dat_sum_HS, n = 1))) # keep only last row (sum) and transpose
plant_sum_HS <- cbind(rownames(plant_sum_HS), data.frame(plant_sum_HS, row.names=NULL)) # row names to column
colnames(plant_sum_HS) <- c("species", "sum")

plant_dat_sum_UNLS <- rbind(plant_mat_UNLS[,-1], colSums(plant_mat_UNLS[-1,-1]))
plant_sum_UNLS <- data.frame(t(tail(plant_dat_sum_UNLS, n= 1))) 
plant_sum_UNLS <- cbind(rownames(plant_sum_UNLS), data.frame(plant_sum_UNLS, row.names=NULL))
colnames(plant_sum_UNLS) <- c("species", "sum")

plant_dat_sum_MANAG <- rbind(plant_mat_MANAG[,-1], colSums(plant_mat_MANAG[-1,-1]))
plant_sum_MANAG <- data.frame(t(tail(plant_dat_sum_MANAG, n = 1))) 
plant_sum_MANAG <- cbind(rownames(plant_sum_MANAG), data.frame(plant_sum_MANAG, row.names=NULL))
colnames(plant_sum_MANAG) <- c("species", "sum")

plant_dat_sum_MULT <- rbind(plant_mat_MULT[,-1], colSums(plant_mat_MULT[-1,-1]))
plant_sum_MULT <- data.frame(t(tail(plant_dat_sum_MULT, n = 1))) 
plant_sum_MULT <- cbind(rownames(plant_sum_MULT), data.frame(plant_sum_MULT, row.names=NULL))
colnames(plant_sum_MULT) <- c("species", "sum")

plant_dat_sum_Rx <- rbind(plant_mat_Rx[,-1], colSums(plant_mat_Rx[-1,-1]))
plant_sum_Rx <- data.frame(t(tail(plant_dat_sum_Rx, n = 1))) 
plant_sum_Rx <- cbind(rownames(plant_sum_Rx), data.frame(plant_sum_Rx, row.names=NULL))
colnames(plant_sum_Rx) <- c("species", "sum")

plant_dat_sum <- plant_sum_UNLS %>% 
  left_join(plant_sum_HS, by = "species") %>% 
  left_join(plant_sum_MANAG, by = "species") %>% 
  left_join(plant_sum_MULT, by = "species") %>% 
  left_join(plant_sum_Rx, by = "species")

colnames(plant_dat_sum) <- c("species", "det_UNLS", "det_HS", "det_MANAG", "det_MULT", "det_Rx")
plant_dat_sum[is.na(plant_dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
plant_dat_percent <- plant_dat_sum %>% 
  mutate(., UNLS_occ = (det_UNLS/(nrow(plant_dat_sum_UNLS) -1)*100)) %>% 
  mutate(., HS_occ = (det_HS/(nrow(plant_dat_sum_HS) -1)*100)) %>% 
  mutate(., MANAG_occ = (det_MANAG/(nrow(plant_dat_sum_MANAG) -1)*100)) %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(plant_dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(plant_dat_sum_Rx) -1)*100))%>% 
  mutate(., total_occ = (det_UNLS + det_HS + det_MANAG + det_MULT + det_Rx)) %>% 
  filter(total_occ >5)  # keep only species detected more than 5 times

print_occ_table <- plant_dat_percent[, -c(2:6)]

write.csv(print_occ_table, file = "output/print_occ_table_all.csv")

```

```{r}
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type
plant_mat_Rx <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MULT <- plant_mat_pa_w %>% 
  left_join(site_data, by = "site_id") %>% 
  filter(sev=="multiple") %>% 
  dplyr::select(ABCO:YAMI)

#Getting the number of detections for each species
plant_dat_sum_MULT <- rbind(plant_mat_MULT[,-1], colSums(plant_mat_MULT[-1,-1]))
plant_sum_MULT <- data.frame(t(tail(plant_dat_sum_MULT, n = 1))) 
plant_sum_MULT <- cbind(rownames(plant_sum_MULT), data.frame(plant_sum_MULT, row.names=NULL))
colnames(plant_sum_MULT) <- c("species", "sum")

plant_dat_sum_Rx <- rbind(plant_mat_Rx[,-1], colSums(plant_mat_Rx[-1,-1]))
plant_sum_Rx <- data.frame(t(tail(plant_dat_sum_Rx, n = 1))) 
plant_sum_Rx <- cbind(rownames(plant_sum_Rx), data.frame(plant_sum_Rx, row.names=NULL))
colnames(plant_sum_Rx) <- c("species", "sum")

plant_dat_sum <- plant_sum_MULT %>% 
  left_join(plant_sum_Rx, by = "species")

colnames(plant_dat_sum) <- c("species", "det_MULT", "det_Rx")
plant_dat_sum[is.na(plant_dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
plant_dat_percent <- plant_dat_sum %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(plant_dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(plant_dat_sum_Rx) -1)*100))

print_occ_table <- plant_dat_percent[, -c(2:3)]

write.csv(print_occ_table, file = "output/print_occ_tab.csv")

```
