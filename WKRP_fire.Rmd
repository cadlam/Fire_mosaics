---
title: "WKRP_fire"
author: "Chris Adlam"
date: "11/15/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r scripts, include = F}
source("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/scripts/data_load.R") #contains packages to load
source("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/scripts/splist2presabs.R") #function for going from species list to presence/absence
source("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/scripts/pairwise_permanova.R")
```

# Abstract

The Klamath Mountains mixed evergreen forest is adapted to frequent, low to moderate severity fires. Today, the Karuk Tribe, US Forest Service, and local community organizations have formed the Western Klamath Restoration Partnership to restore this fire regime, altered by a century of fire suppression. Part of the WKRPâ€™s mission is to address concerns about the impacts on biodiversity of both high severity fire and the exclusion of fire and resulting changes to forest structure. I investigate patterns of plant, bird, lichen and insect diversity and community composition after low and high severity burns and in long-unburnt stands. Then I evaluate the response of diversity to two management options that can reduce canopy cover to within its historical range: multiple burns (a proxy for wildland fire use) and thinning and burning. I sampled plant, bird, lichen and insect communities in 110 plots across the WKRP project area. Low severity burns and unburnt areas did not differ in species composition. Plant, bird and insect diversity (alpha, beta and gamma) were as high or higher in high severity burns as in low severity/unburnt stands. Lichens were negatively impacted by high severity fire, beginning to recover only after 16 years. Multiple burns and thinned/burnt stands were the highest in diversity, because they provided habitat for both species preferring high severity burns and those preferring low severity /unburnt stands. This suggests that management, whether passive (allowing fires to burn and overlap) or active (thinning and burning) can help maintain biodiversity in this fire-dependent landscape.


# Introduction

## Sampling strategy
In June/July 2018 and 2019, I sampled 110 plots from high severity burns (HS), low severity burns (LS), long-unburnt areas (UN), multiple burns (MULT), and prescribed burns (Rx). HS sites were defined as having >75 % canopy reduction, and LS sites as <25% canopy reduction. Based on personal observation, a reduction in canopy cover of 25-75% is uncommon in the Klamath Mountains, because canopy continuity is such that fires tend to be either surface or canopy fires. MULT and Rx sites were not randomly distributed; rather I targeted stands where the canopy had been reduced to 30-75%, which I am assuming to be closer to the historic range of variation pre-fire-suppression.


# Habitat clustering

First, I take a look at which habitats have similar or different species composition, using PERMANOVA and MRPP.

## PERMANOVA
For all taxa, there is an effect of habitat (main PERMANOVA, p < 0.001; not shown). 

### Pairwise comparisons
Using pairwise PERMANOVAs to compare the habitats, there is no detectable difference between plant, bird or lichen communities of LS and UN habitat (plants: p = 0.22; birds: p = 0.09 lichens: p = 1). For this reason, I will from here on lump UN and LS together.

In addition, bird communities of HS and MULT are not detectably different (p = 0.76). For lichens, the only habitat that stands out is the HS habitat (p < 0.01), although it is not statistically different from the MULT habitat (p = 1).

### Main Permanova (plants)
* Just using LS/UN/HS to show that LS and UN can be lumped together.
* Main PERMANOVA shows that there is an effect of sev and of tsf (in categories).

```{r PERMANOVA_plants, echo = F}
### Is there an effect of sev and time since fire (using categories)? Yes for sev, no for tsf


#### Worth checking: there was an effect of tsf and an interaction using all plots incl. mult and Rx

# using on sites between 5 and 20 years old (and UN)

comp.data <- plant_dat_cov_w #%>%  #filter(sev %in% c("l", "h", "u"))
#    filter(sev == "multiple")

comp.sub <- subset(comp.data, select = ABCO:YAMI)
comp.env <- subset(comp.data, select = c(sev3, tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_plants <- kable(adonis2(log1p(comp.sub) ~ sev, permutations = 999), caption = "Table 1: PERMANOVA results (plants, cover)", digits = 5) %>%
  kable_styling()
PERMANOVA_sev_plants

## Pairwise PERMANOVA
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair_plants <- pairwise.adonis(log1p(comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_plants <- kable(pair_plants, caption = "Table 2: pairwise PERMANOVA results", digits = 5) %>%
  kable_styling()
pairwise_sev_plants

```

```{r PERMANOVA_all, echo = F}
#all spp
comp.data <- all_spp_dat_w #%>%  #filter(sev %in% c("l", "h", "u"))
#  filter((tsf < 25 & tsf > 4) | sev == "u")# %>%
#  filter((sev == "multiple" & tree_cov > 45) | sev != "multiple")
  
comp.sub <- subset(comp.data, select = ACMA:YRWA)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_all <-kable(adonis2(comp.sub ~ sev, permutations = 9999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() 
PERMANOVA_sev_all

## Pairwise PERMANOVA function (run)
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair <- pairwise.adonis((comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_all <- kable(pair, caption = "Table 2: pairwise PERMANOVA results", digits = 4) %>%
  kable_styling()
pairwise_sev_all

```

```{r PERMANOVA_birds, echo = F}
#birds
comp.data <- bird_dat_w #%>%  #filter(sev %in% c("l", "h", "u"))
#  filter((tsf < 25 & tsf > 4) | sev == "u")# %>%
#  filter((sev == "multiple" & tree_cov > 45) | sev != "multiple")
  
comp.sub <- subset(comp.data, select = ACWO:YRWA)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_birds <- kable(adonis2(comp.sub ~ sev, permutations = 9999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() 
PERMANOVA_sev_birds 

## Pairwise PERMANOVA function (run)
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair_birds <- pairwise.adonis((comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_birds <- kable(pair_birds, caption = "Table 2: pairwise PERMANOVA results", digits = 4) %>%
  kable_styling()
pairwise_sev_birds

```

```{r PERMANOVA_lichens, echo = F}
#lichens
comp.data <- lichen_dat_genus_pa_w #%>%  #filter(sev %in% c("l", "h", "u"))
#  filter((tsf < 25 & tsf > 4) | sev == "u")# %>%
#  filter((sev == "multiple" & tree_cov > 45) | sev != "multiple")
  
comp.sub <- subset(comp.data, select = Ahtiana:Xanthomendoza)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_lichens <- kable(adonis2(comp.sub ~ sev, permutations = 9999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() 
PERMANOVA_sev_lichens

## Pairwise PERMANOVA function (run)
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair_lichens <- pairwise.adonis((comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_lichens <- kable(pair_lichens, caption = "Table 2: pairwise PERMANOVA results", digits = 4) %>%
  kable_styling()
pairwise_sev_lichens
```

```{r all_pairwise_table, echo = F}
# Making a table of all pairwise comparisons
pairs <- c("HS vs LS", "LS vs MULT", "LS vs UN", "LS vs Rx", "HS vs MULT", "LS vs UN", "HS vs Rx", "MULT vs UN", "MULT vs Rx", "UN vs RX")
plants_F <-pair_plants$F.Model
plants_P <-pair_plants$p.adjusted
birds_F <-pair_birds$F.Model
birds_P <-pair_birds$p.adjusted
lichens_F <- pair_lichens$F.Model
lichens_P <-pair_lichens$p.adjusted

all_pairwise_table <- data.frame(pairs, plants_F, plants_P, birds_F, birds_P, lichens_F,lichens_P)

names(all_pairwise_table) <- c("Pair", "F_model", "p_adj", "F_model", "p_adj", "F_model", "p_adj")

all_pairwise_table <- all_pairwise_table[order(all_pairwise_table$Pair),]
rownames(all_pairwise_table) <- c()

kable(all_pairwise_table) %>% 
  kable_styling("hover", full_width = F) %>%
  add_header_above(c(" ", "plants" = 2, "birds" = 2, "lichens" = 2))

```


## MRPP
* MRPP instead of PERMANOVA?
```{r echo = F}
#plants
# seems to work better with cov than pa (no convergence)
mrpp_data <- plant_dat_pa_w %>% # [,c(2:82)]
#  filter(sev %in% c("l","h", "u")) %>% 
#  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
  dplyr::select(ABCO:YAMI) %>% 
  dplyr::select(which(colSums(.) > 0)) 

mrpp_cat <- plant_dat_pa_w %>% 
#  filter(sev %in% c("l","h", "u")) %>% 
#  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
#  select(site_id, sev)
  dplyr::select(sev)
  
mrpp_cat$sev <- as.factor(mrpp_cat$sev)
  
plant.mrpp <- mrpp(mrpp_data, mrpp_cat)


# Save and change plotting parameters
def.par <- par(no.readonly = TRUE)
layout(matrix(1:2,nr=1))

plot(plant.ord <- metaMDS(sqrt(mrpp_data), type="text", display="sites"))
#ordihull(plant.ord, mrpp_cat, label = T)

with(plant.mrpp, {
  fig.dist <- hist(boot.deltas, xlim=range(c(delta,boot.deltas)), 
                 main="Test of Differences Among Groups")
  abline(v=delta); 
  text(delta, 2*mean(fig.dist$counts), adj = -0.5,
     expression(bold(delta)), cex=1.5 )  }
)
par(def.par)


## meandist 
# calculates a matrix of mean within-cluster dissimilarities (diagonal) and between-cluster dissimilarities (off-diagonal elements)
plant.md <- meandist(vegdist(mrpp_data, mrpp_cat, method = "raup")) # Need to adjust the columns to only keep species.... should fix this
plant.md
summary(plant.md)
plot(plant.md)











#plants
# seems to work better with cov than pa (no convergence)
mrpp_data <- all_spp_dat_w %>% # [,c(2:82)]
#  filter(sev %in% c("l","h", "u")) %>% 
  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
  dplyr::select(ABPR:YRWA) %>% 
  dplyr::select(which(colSums(.) > 0)) 

mrpp_cat <- all_spp_dat_w %>% 
#  filter(sev %in% c("l","h", "u")) %>% 
  filter((tsf < 25 & tsf >= 4) | sev == "u") %>% 
#  select(site_id, sev)
  dplyr::select(sev)
  
mrpp_cat$sev <- as.factor(mrpp_cat$sev)
  
plant.mrpp <- mrpp(mrpp_data, mrpp_cat)
summary(plant.mrpp)


# Save and change plotting parameters
def.par <- par(no.readonly = TRUE)
layout(matrix(1:2,nr=1))

plot(plant.ord <- metaMDS(sqrt(mrpp_data), type="text", display="sites"))
ordihull(plant.ord, mrpp_cat, label = T)

with(plant.mrpp, {
  fig.dist <- hist(boot.deltas, xlim=range(c(delta,boot.deltas)), 
                 main="Test of Differences Among Groups")
  abline(v=delta); 
  text(delta, 2*mean(fig.dist$counts), adj = -0.5,
     expression(bold(delta)), cex=1.5 )  }
)
par(def.par)


## meandist 
# calculates a matrix of mean within-cluster dissimilarities (diagonal) and between-cluster dissimilarities (off-diagonal elements)
plant.md <- meandist(vegdist(mrpp_data, mrpp_cat, binary = T, method ="raup")) # Need to adjust the columns to only keep species.... should fix this
plant.md
summary(plant.md)
plot(plant.md)


```

# Alpha, Beta, Gamma div.

#### Species number vs TSF plots
```{r}

plant_div2 <- plant_div %>%  # see below
  filter(tsf < 25 & tsf > 4)

ggplot(plant_div2, aes(x=tsf, y=simpson)) +
  geom_point(aes(colour=sev)) +
  geom_smooth(aes(colour=sev), method = "lm")

all_spp_div2 <-all_spp_div %>% 
  filter(tsf < 25 & tsf > 4)

ggplot(all_spp_div2, aes(x=tsf, y=simpson)) +
  geom_point(aes(colour=sev)) +
  geom_smooth(aes(colour=sev), method = "lm")

bird_div2 <-bird_div %>% 
  filter(tsf < 25)

ggplot(bird_div2, aes(x=tsf, y=simpson)) +
  geom_point(aes(colour=sev)) +
  geom_smooth(aes(colour=sev), method = "lm")

```

## Alpha
### All_spp
```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
all_richness <- ddply(all_spp_w_pa,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

all_div1 <- merge(all_richness, site_data, by = "site_id") 

all_alpha <- ggplot(all_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("All spp richness") +
  xlab("Habitat")  +
    geom_text(aes(x = sev3, 
                y = emmean + 25),
            label = alpha_rich_stats_all$.group, 
            data = alpha_rich_stats_all) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```


### Birds
```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
bird_richness <- ddply(bird_mat_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

bird_div1 <- merge(bird_richness, site_data, by = "site_id")

bird_alpha <- ggplot(bird_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("Bird richness") +
  xlab("Habitat")  +
    geom_text(aes(x = sev3, 
                y = emmean + 10),
            label = alpha_rich_stats_bird$.group, 
            data = alpha_rich_stats_bird) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```

### Plants (pa)
```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
plant <- ddply(plant_mat_pa_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

plant_div1 <- merge(plant_richness, site_data, by = "site_id")

plant_alpha <- ggplot(plant_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("Plant richness") +
  xlab("Habitat")  +
    geom_text(aes(x = sev3, 
                y = emmean + 25),
            label = alpha_rich_stats_plant$.group, 
            data = alpha_rich_stats_plant) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```

### lichens (pa)
```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
lichen_richness <- ddply(lichen_mat_genus_pa_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

lichen_div1 <- merge(lichen_richness, site_data, by = "site_id")

lich_alpha <- ggplot(lichen_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("lichen richness") +
  xlab("Habitat")  +
  geom_text(aes(x = sev3, 
                y = emmean + 20),
            label = alpha_rich_stats_lichen$.group, 
            data = alpha_rich_stats_lichen) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```

### All alpha plots
(except insects)
```{r}
grid.arrange(all_alpha, bird_alpha, plant_alpha, lich_alpha, nrow = 2)

```


### Insects (Alpha, beta, gamma)
12/11/19

Diversity patterns between HS and LS/UN are not striking. Slightly lower in UN/LS but barely. But the abundance difference is huge for many spp. The indicator analysis is much more interesting.

```{r}
# Insect alpha

gamma.matrix <- insect_mat %>% 
  dplyr::select(c(site_id, Aculeata:Thysanoptera)) %>% 
  group_by(site_id)

comp.attr = insect_dat_w %>% dplyr::select(site_id)
comp.abund <- gamma.matrix %>% ungroup() %>% dplyr::select(c(Aculeata:Thysanoptera))


richA = specnumber(comp.abund)
#shanA = exp(diversity(comp.abund, index = "shannon")) # not working
shanA <- diversityresult(x = comp.abund, y= NULL, index="Shannon", method = "each site", sortit = FALSE)
#simpA = diversity(comp.abund, index = "invsimpson")
simpA = -(1/(diversityresult(x = comp.abund, y= NULL, index="Simpson", method = "each site", sortit = FALSE) - 1)) # for some reason I coudn't get the direct calculation of inverse Simpson to work, but this seems to do the trick
# Actually not a mistake....... WHY is inverse simpson the same as richness? 


richA = specnumber(comp.abund)
shanA = exp(diversity(comp.abund, index = "shannon"))
simpA = diversity(comp.abund, index = "invsimpson")

alpha.stats = data.frame(comp.attr, richA, shanA, simpA)

names(alpha.stats)[2] <- "richA"
names(alpha.stats)[3] <- "shanA"
names(alpha.stats)[4] <- "simpA"


# Insect gamma
gamma.matrix <- insect_dat_w %>%   
  dplyr::select(c(sev, Aculeata:Thysanoptera)) %>% 
  group_by(sev) %>% 
  #mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev =="multiple", "h", sev))) %>%
  mutate(sev3 = ifelse(sev =="multiple", "h", sev)) %>%
  group_by(sev3) %>% 
  dplyr::select(-sev) %>% 
  summarise_all(sum)

gamma.attr = gamma.matrix %>% dplyr::select(sev3)
gamma.abund = gamma.matrix %>% dplyr::select(-sev3) 
  
richG = specnumber(gamma.abund)
shanG = exp(diversity(gamma.abund, index = "shannon"))
simpG = diversity(gamma.abund, index = "invsimpson")

gamma.stats = data.frame(gamma.attr, richG, shanG, simpG)


#gamma.stats_i = data.frame(gamma.attr_i, richG_insects)

#richGinsect <- ggplot(gamma.stats_i, aes(x = sev3, y = richG_insects, fill = sev3)) +
#  geom_point(shape = 21, color = "black", size = 3) +  ggtitle("All gamma") +
#  xlab("Habitat")  +
#  ylab("gamma")  +
#  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)







alldiv = left_join(alpha.stats, site_data, by = "site_id") %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev =="multiple", "h", sev))) %>%
  mutate(sev3 = ifelse(sev =="multiple", "h", sev)) %>%
  left_join(gamma.stats) %>% 
  mutate(richB = richG / richA,
         shanB = shanG / shanA,
         simpB = simpG / simpA) 



# Figures
# Alpha figures
p7 <- alldiv %>% 
  ggplot(aes(x = sev3, y = richA,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) +
  ggtitle("Alpha-Level Richness")+
  ylab("Species Richness")  +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none") + theme(aspect.ratio=1)

p8 <- alldiv %>% ggplot(aes(x = sev3,
                      y = shanA,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~tsf_cat) +
  ggtitle("Alpha-Level Exp. Shannon")+
  ylab("Exp. Shannon Diversity Index")  +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p9 <- alldiv %>% ggplot(aes(x = sev3,
                      y = simpA,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) + 
  ggtitle("Alpha-Level Inv. Simpson") +
  ylab("Inv. Simpson Diversity Index") +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)


#gammma figures
p1 <- alldiv %>% 
  ggplot(aes(x = sev3, y = richG,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
#  facet_wrap(~year) +
  ggtitle("Gamma-Level Richness")+
  ylab("Species Richness")  +
  xlab("Habitat") +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none") + theme(aspect.ratio=1)

p2 <- alldiv %>% ggplot(aes(x = sev3,
                      y = shanG,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
#  facet_wrap(~tsf_cat) +
  ggtitle("Gamma-Level Exp. Shannon")+
  ylab("Exp. Shannon Diversity Index")  +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p3 <- alldiv %>% ggplot(aes(x = sev3,
                      y = simpG,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
#  facet_wrap(~year) + 
  ggtitle("Gamma-Level Inv. Simpson") +
  ylab("Inv. Simpson Diversity Index") +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

#beta figures
p4 <- alldiv %>% ggplot(aes(x = sev3,
                      y = richB,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) +
  ggtitle("Beta-Level Richness")+
  ylab("Species Richness")  +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p5 <- alldiv %>% ggplot(aes(x = sev3,
                      y = shanB,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) +
  ggtitle("Beta-Level Exp. Shannon")+
  ylab("Exp. Shannon Diversity Index")  +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

p6 <- alldiv %>% ggplot(aes(x = sev3,
                      y = simpB,
                      fill = factor(sev3),
                      group = sev3)) +
  geom_boxplot() +
#  facet_wrap(~year) + 
  ggtitle("Beta-Level Inv. Simpson") +
  ylab("Inv. Simpson Diversity Index")  +
  xlab("Habitat")  +
  expand_limits(y = 0) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

grid.arrange(p7, p8, p9, p4, p5, p6, p1, p2, p3, nrow =3)
```


#### Plants only (cov; plus shannon/simpson)
*Div highest, in mnanag; lowest in LS/UN, intermediate in HS (looks not so different from mult/Rx). Haven't done tests for cover.
* (Similar to all_spp analysis, LS is actually comparable to HS in diversity when separated from UN.)

```{r}
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
plant_richness <- ddply(plant_mat_cov_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

# Shannon diversity
plant_shannon <- ddply(plant_mat_cov_w,~site_id,function(x) {
        data.frame(shannon=diversity(x[-1], index="shannon"))
})

plant_simpson <- ddply(plant_mat_cov_w,~site_id,function(x) {
        data.frame(simpson=diversity(x[-1], index="simpson"))
})

#put it together
plant_div <- merge(plant_richness, plant_shannon, by = "site_id") %>%
  merge(., plant_simpson, by = "site_id") %>% 
  merge(., site_data, by = "site_id")

#all_spp_div  %>%
#  group_by(sev) %>%
#  summarise_all(mean, na.rm=TRUE)

plant_div$cov_cat <- as.factor(plant_div$cov_cat) 

plant_div1 <- plant_div #%>%   
  #  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev))
  
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev == "Rx" | sev == "multiple", "manag", sev)))

plant1 <- ggplot(plant_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot()  +
  ggtitle("Plant richness") +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

plant2 <- ggplot(plant_div1, aes(x = sev3, y = shannon, fill = sev3)) +
  geom_boxplot() +
  ggtitle("Plant Shannon") +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

plant3 <- ggplot(plant_div1, aes(x = sev3, y = simpson, fill = sev3)) +
  geom_boxplot()  +
  ggtitle("Plant Simpson") +
  xlab("Habitat")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

plant_all_plots <- grid.arrange(plant1, plant2, plant3, nrow=1) 
# do anovas to test differences?
```


## Gamma diversity calculation and rarefaction curves
```{r}
# Species accumulation curves
# All SPP
all_spp_matrix <- merge(all_spp_w_pa, site_data, by = "site_id") %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,ABCO:YRWA)


#subset each habitat into its own df
all_spp_matrix %>% filter(sev3 == "h") -> h
all_spp_matrix %>% filter(sev3 == "lu") -> lu
all_spp_matrix %>% filter(sev3 == "multiple") -> multiple
all_spp_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "LS/UN")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")


# ggplot species accummulation curves
all_acc <- ggplot() +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h , colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = "coral1") +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = "chartreuse4") +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = "cyan3") +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = "darkorchid3") +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("All Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species") 


# Birds
bird_matrix <- bird_dat_w %>% 
  #mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,ACWO:YRWA)

#subset each habitat into its own df
bird_matrix %>% filter(sev3 == "h") -> h
bird_matrix %>% filter(sev3 == "lu") -> lu
bird_matrix %>% filter(sev3 == "multiple") -> multiple
bird_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "LS/UN")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")

birds_acc <- ggplot() +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h , colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = "coral1") +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = "chartreuse4") +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = "cyan3") +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = "darkorchid3") +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("Bird Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species") 
  
# Plants
plant_matrix <- plant_dat_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,ABCO:YAMI)

#subset each habitat into its own df
plant_matrix %>% filter(sev3 == "h") -> h
plant_matrix %>% filter(sev3 == "lu") -> lu
plant_matrix %>% filter(sev3 == "multiple") -> multiple
plant_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "LS/UN")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")

plants_acc <- ggplot() +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h , colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = "coral1") +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = "chartreuse4") +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = "cyan3") +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = "darkorchid3") +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("Plant Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species") 
  
# Lichens
lichen_matrix <- lichen_dat_genus_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,Ahtiana:Xanthomendoza)

#subset each habitat into its own df
lichen_matrix %>% filter(sev3 == "h") -> h
lichen_matrix %>% filter(sev3 == "lu") -> lu
lichen_matrix %>% filter(sev3 == "multiple") -> multiple
lichen_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "LS/UN")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")

lichen_acc <- ggplot() +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h , colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = "coral1") +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = "chartreuse4") +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = "cyan3") +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = "darkorchid3") +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("Lichen Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species")  

legend <- gtable_filter(ggplot_gtable(ggplot_build(lichen_acc + theme(legend.position="right")+ theme(legend.title = element_blank()))), "guide-box")

  
sp_acc_plots <- grid.arrange(all_acc, birds_acc, legend, plants_acc, lichen_acc,
            # heights=c(1.1, 1.1, 0.1),
            widths = c(2.5, 2.5, 0.5),
             ncol = 3, nrow = 2)



```

## Alt Gamma
```{r}
  
#Gamma
#ALL SPP
gamma.matrix_all <- all_spp_dat_w %>% 
  dplyr::select(c(sev, ABCO:YRWA)) %>% 
  group_by(sev) %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  group_by(sev3) %>% 
  dplyr::select(-sev) %>% 
  summarise_all(sum)

gamma.attr = gamma.matrix_all %>% dplyr::select(sev3)
gamma.abund_all = gamma.matrix_all %>% dplyr::select(-sev3) 

#birds
gamma.matrix_birds <- bird_dat_w %>%   
  dplyr::select(c(sev, ACWO:YRWA)) %>% 
  group_by(sev) %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  group_by(sev3) %>% 
  dplyr::select(-sev) %>% 
  summarise_all(sum)

gamma.abund_birds = gamma.matrix_birds %>% dplyr::select(-sev3) 

#Plants
gamma.matrix_plants <- plant_dat_pa_w %>% 
  dplyr::select(c(sev, ABCO:YAMI)) %>% 
  group_by(sev) %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  group_by(sev3) %>% 
  dplyr::select(-sev) %>% 
  summarise_all(sum)

gamma.abund_plants = gamma.matrix_plants %>% dplyr::select(-sev3) 

#PLichens (use species instead of genus)
gamma.matrix_lichens <- lichen_dat_species_w %>% 
  dplyr::select(c(sev, AHPA:XAHA)) %>% 
  group_by(sev) %>% 
  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  group_by(sev3) %>% 
  dplyr::select(-sev) %>% 
  summarise_all(sum)

gamma.abund_lichens = gamma.matrix_lichens %>% dplyr::select(-sev3) 

#Putting it all together
richG_all = specnumber(gamma.abund_all)
richG_birds = specnumber(gamma.abund_birds)
richG_plants = specnumber(gamma.abund_plants)
richG_lichens = specnumber(gamma.abund_lichens)

gamma.stats = data.frame(gamma.attr, richG_all, richG_birds, richG_plants, richG_lichens)

# Plots
richGall <- ggplot(gamma.stats, aes(x = sev3, y = richG_all, fill = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +  ggtitle("All gamma") +
  xlab("Habitat")  +
  ylab("gamma")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

richGbirds <- ggplot(gamma.stats, aes(x = sev3, y = richG_birds, fill = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
  ggtitle("Bird gamma") +
  xlab("Habitat")  +
  ylab("gamma")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

richGplant <- ggplot(gamma.stats, aes(x = sev3, y = richG_plants, fill = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
  ggtitle("Plant gamma") +
  xlab("Habitat")  +
  ylab("gamma")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

richGlich <- ggplot(gamma.stats, aes(x = sev3, y = richG_lichens, fill = sev3)) +
  geom_point(shape = 21, color = "black", size = 3) +
  ggtitle("Lichen gamma") +
  xlab("Habitat")  +
  ylab("gamma")  +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

grid.arrange(richGall, richGbirds, richGplant, richGlich, nrow = 2)


```

## Beta Diversity (binomial)
Note: for cld letters, need to run code in chunk below
```{r}
# Code from Jonah

beta <- function(df){
  
  tempdf = df %>% dplyr::select(-sev3)
  
  dis = c(vegdist(tempdf, method = "binomial", binary = "true", na.rm = TRUE))
  
  result = data.frame(sev3 = rep(unique(df$sev3), length = length(dis)),
#                      year = rep(unique(df$year), length = length(dis)),
                      dis = dis)
  
}


#all spp
comptable <-  all_spp_w_pa %>% full_join(site_data[, c("site_id", "sev3")], by = "site_id") %>%
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(-c(site_id))

bj_output_all = comptable %>% group_by(sev3) %>% do(beta(.))

beta_all <- bj_output_all %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("All spp Pairwise Beta Div. (binomial)")   +
   geom_text(aes(x = sev3, 
                y = 60),
            label = all_beta_cld$.group, 
            data = all_beta_cld) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)


#birds
comptable <-  bird_dat_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ACWO:YRWA))

bj_output_birds = comptable %>% group_by(sev3) %>% do(beta(.))

beta_birds <- bj_output_birds %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Bird Pairwise Beta Div. (binomial)")   +
    geom_text(aes(x = sev3, 
                y = 20),
            label = bird_beta_cld$.group, 
            data = bird_beta_cld) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)


#plants (cov)
#remember to alter above function to use jaccard instead of binomial (and binary = false)
comptable <-  plant_dat_cov_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ABCO:YAMI)) 

bj_output_plants_cov = comptable %>% group_by(sev3) %>% do(beta(.))

beta_plants_cov <- bj_output_plants_cov %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Plant Pairwise Beta Div. (jaccard)")   +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

#plants (pa)
comptable <-  plant_dat_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ABCO:YAMI)) 

bj_output_plants_pa = comptable %>% group_by(sev3) %>% do(beta(.))

beta_plants_pa <- bj_output_plants_pa %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Plant Pairwise Beta Div. (binomial)")   +
    geom_text(aes(x = sev3, 
                y = 45),
            label = plant_beta_cld$.group, 
            data = plant_beta_cld) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

#lichens (pa)
comptable <-  lichen_dat_genus_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, Ahtiana:Xanthomendoza)) %>% 
  dplyr::select(-Dummy)

bj_output_lichens = comptable %>% group_by(sev3) %>% do(beta(.))

beta_lichen_pa <- bj_output_lichens %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Lichen Pairwise Beta Div. (binomial)")   +
    geom_text(aes(x = sev3, 
                y = 13),
            label = lichen_beta_cld$.group, 
            data = lichen_beta_cld) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)




# Putting plots together
grid.arrange(beta_all, beta_birds, beta_plants_pa, beta_lichen_pa, nrow = 2)
```

# Calculating Statistical Differences Between Groups:

## Alpha Diversity
```{r}
# Writing a simple model
# richness tests
div <- all_div1 %>% dplyr::mutate(., rich_all = richness) %>% 
  dplyr::select(-richness) %>% 
  merge(., bird_div1[, c(1:2)], by = "site_id") %>% mutate(., rich_bird = richness) %>%
  dplyr::select(-richness) %>% 
  merge(., plant_div1[, c(1:2)], by = "site_id") %>% mutate(., rich_plant = richness) %>%
  dplyr::select(-richness) %>% 
  merge(., lichen_div1[, c(1:2)], by = "site_id") %>% mutate(., rich_lichen = richness) %>%
  dplyr::select(-richness)

#12/12/19
#  LU is statistically different (lower), RX is statistically different (higher); h is similar to lu and mult; mult is similar to h but separate from Rx (lu:a; h:ab; mult:b; Rx:c)
mod_add_all = lm(rich_all ~ sev3, data = div)
anova(mod_add_all)
means = emmeans(mod_add_all, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_all <- as.data.frame(cld(means$emmeans, Letters = letters))

#  LU is statistically different (lower), RX is statistically different (higher); h is similar to lu and mult; mult is similar to h and Rx (a; ab; bc; c)
mod_add_bird = lm(rich_bird ~ sev3, data = div)
anova(mod_add_bird)
means = emmeans(mod_add_bird, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_bird <- as.data.frame(cld(means$emmeans, Letters = letters))

#similar to bird pattern (lu: a, h: ab, mult:bc, Rx:c)
mod_add_plant = lm(rich_plant ~ sev3, data = div)
anova(mod_add_plant)
means = emmeans(mod_add_plant, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_plant <- as.data.frame(cld(means$emmeans, Letters = letters))

# LU is statistically different (higher), yet not different from Rx; h and mult are higher, though not diff from Rx. (h: a, mult: a, Rx: ab, lu:b)
mod_add_lichen = lm(rich_lichen ~ sev3, data = div)
anova(mod_add_lichen)
means = emmeans(mod_add_lichen, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_lichen <- as.data.frame(cld(means$emmeans, Letters = letters))

```

##beta

```{r}
#12/12/19
#  LU is statistically different (lower), RX is statistically different (higher); h is similar to lu and mult; mult is similar to h and Rx


#lu is stat lower; mult stat higher; h and Rx in between not diff
mod_add_all = lm(dis~ sev3, data = bj_output_all)
anova(mod_add_all)
means = emmeans(mod_add_all, pairwise~sev3)
all_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))

# mult and h are higher, not diff, then Rx, then lu
mod_add_bird = lm(dis~ sev3, data = bj_output_birds)
anova(mod_add_bird)
means = emmeans(mod_add_bird, pairwise~sev3)
bird_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))

# lu lowest, Rx highest (lu: a, h: ab, mult: bc, Rx: c)
mod_add_plant = lm(dis~ sev3, data = bj_output_plants_pa)
anova(mod_add_plant)
means = emmeans(mod_add_plant, pairwise~sev3)
plant_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))

# LU is statistically different (higher), but others are not
mod_add_lichen = lm(dis~ sev3, data = bj_output_lichens)
anova(mod_add_lichen)
means = emmeans(mod_add_lichen, pairwise~sev3)
lichen_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))




#shannon

# Fitting an interactive model and an additive model
mod_int_shan = lmer(shanA ~ OBS_FIRE_SEV + year + OBS_FIRE_SEV:year + (1|Regen_ID), data = alldiv)
mod_add_shan = lmer(shanA ~ OBS_FIRE_SEV + year + (1|Regen_ID), data = alldiv)

# Are these two models significantly different from one another? Look for a p < .05
# (Likelihood ratio test)
anova(mod_add_shan, mod_int_shan)

# What's the model ANOVA table - interaction one has lower AIC
anova(mod_int_shan)
summary(mod_int_shan)
# capture.output(anova(mod_int_shan),file="alpha_shan_anova")

# Estimated means between groups within each year
means_shan = emmeans(mod_int_shan, specs = "OBS_FIRE_SEV", by = "year", adjust = "tukey")

# All pairwise comparisons
paircomp_shan = pairs(means_shan)

# Assigning labels to each groups
CLD(means_shan)

#create dataframe to use for labeling shannon boxplots
alpha_shan_stats <- as.data.frame(CLD(means_shan))

```

##Simpsons

```{r}
#simpsons

# Fitting an interactive model and an additive model
mod_int_simp = lmer(simpA ~ OBS_FIRE_SEV + year + OBS_FIRE_SEV:year + (1|Regen_ID), data = alldiv)
mod_add_simp = lmer(simpA ~ OBS_FIRE_SEV + year + (1|Regen_ID), data = alldiv)

# Are these two models significantly different from one another? Look for a p < .05
# (Likelihood ratio test)
anova(mod_add_simp, mod_int_simp)

# What's the model ANOVA table - interaction one has lower AIC
anova(mod_int_simp)

# capture.output(anova(mod_int_simp),file="alpha_simp_anova")

# Estimated means between groups within each year
means_simp = emmeans(mod_int_simp, specs = "OBS_FIRE_SEV", by = "year", adjust = "tukey")

# All pairwise comparisons
paircomp_simp = pairs(means_simp)

# Assigning labels to each groups
CLD(means_simp)

#create dataframe to use for labeling shannon boxplots
alpha_simp_stats <- as.data.frame(CLD(means_simp))

```


# Indicator species analysis for plants (HS vs LS/UN)
* Doesn't turn up many species and fails to return anything when Mult and Rx are included

```{r echo = F}
### Community data matrix
plant_data_filtered <- plant_dat_pa_l %>% 
#  select(-DUMB) %>% 
  left_join(., site_data, by = "site_id") %>% 
  filter(sev %in% c("l", "h", "u")) 

plant_dat <- left_join(plant_data_filtered, plant_names, by = "species") %>%
  mutate(sev2 = ifelse(sev == 'h' , "h", "lu")) 

plant_dat_select  <- plant_dat %>%
  dplyr::select(site_id, species, pa, sev, sev_tsf, sev2)

plant_matrix1 <- spread(data = plant_dat_select, key = species, value = pa, fill = 0)

# getting rid of species detected in 0 plots (for some reason there appears to be no cover recorded for ALRH and CESA, but they were both found at only one plot so no big deal)
plant_matrix1 <- plant_matrix1 %>% 
  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))

plant_matrix1 <- plant_matrix1[, (plant_matrix1[57, ]) > 0]
plant_matrix1 <- plant_matrix1[-57, ]


### Vector for site classification
### severity
data <- plant_matrix1[,-c(1:4)]
groups1 <- as.vector(plant_matrix1$sev2)

#groups1 = as.vector(plant_dat$tsf_cat2)
#groups1 = as.vector(plant_dat$sev_tsf)

Indval_out1 <- indval(data, groups1, numitr=10000)
gr <- Indval_out1$maxcls[Indval_out1$pval<=0.05]
iv <- Indval_out1$indcls[Indval_out1$pval<=0.05]
pv <- Indval_out1$pval[Indval_out1$pval<=0.05]
fr <- apply(data>0, 2, sum)[Indval_out1$pval<=0.05]
indvalsummary <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
indvalsummary1 <- indvalsummary[order(indvalsummary$group, -indvalsummary$indval),]
prob.corrected1 = p.adjust(Indval_out1$pval, "BH") # correct p.value for multiple testing
#kable(indvalsummary1)

indvalsummary1 <- cbind(rownames(indvalsummary1), data.frame(indvalsummary1, row.names=NULL))

names(indvalsummary1)[1]<-"species"

indval <- left_join(indvalsummary1, plant_names, by = "species") %>% 
  mutate(HS_ind = ifelse(is.na(full_name), species, full_name)) %>% 
  dplyr::select(HS_ind, group, indval, pvalue) %>% 
  mutate("Indicator value" = indval * 100) %>% 
  filter(indval >= 0.25) %>% 
  filter(pvalue < 0.05)

indval_hs <- indval %>% 
  filter(group =="1") %>% 
  dplyr::select(HS_ind, "Indicator value")

indval_ls <- indval %>% 
  filter(group =="2")%>% 
  dplyr::select(HS_ind, "Indicator value")

names(indval_hs)[1]<-"Indicators of HS"
names(indval_ls)[1]<-"Indicators of LS/UN"


#names(spp_diff2)[1]<-"Species found only in LS/UN"
indval_table <- list(indval_hs, indval_ls)

kable(indval_table, caption = "Table 3: Indicator species for different habitats (HS vs LS/UN)", digits = 0) %>%
  kable_styling()

#write.csv(indvalsummary1, file = "indvalsummary1.csv")
#write.csv(prob.corrected1, file = "prob.corrected1.csv")
```

#Insect Ind. Analysis
12/11/19
```{r echo = F}

insect_matrix <- insect_dat_w %>%   
  dplyr::select(c(site_id, sev, Aculeata:Thysanoptera)) %>% 
#  group_by(sev) %>% 
  #mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev =="multiple", "h", sev))) %>%
  mutate(sev3 = ifelse(sev =="multiple", "h", ifelse(sev == "u" | sev == "l", "lu", sev)))

# getting rid of species detected in 0 plots (for some reason there appears to be no cover recorded for ALRH and CESA, but they were both found at only one plot so no big deal)
plant_matrix1 <- insect_matrix %>% 
  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))

plant_matrix1 <- insect_matrix[, (plant_matrix1[57, ]) > 0]
plant_matrix1 <- insect_matrix[-57, ]


### Vector for site classification
### severity
data <- insect_matrix %>% dplyr::select(c(Aculeata:Thysanoptera))
groups1 <- as.vector(insect_matrix$sev3)

#groups1 = as.vector(plant_dat$tsf_cat2)
#groups1 = as.vector(plant_dat$sev_tsf)

Indval_out1 <- indval(data, groups1, numitr=10000)
gr <- Indval_out1$maxcls[Indval_out1$pval<=0.1]
iv <- Indval_out1$indcls[Indval_out1$pval<=0.1]
pv <- Indval_out1$pval[Indval_out1$pval<=0.1]
fr <- apply(data>0, 2, sum)[Indval_out1$pval<=0.1]
indvalsummary <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
indvalsummary1 <- indvalsummary[order(indvalsummary$group, -indvalsummary$indval),]
prob.corrected1 = p.adjust(Indval_out1$pval, "BH") # correct p.value for multiple testing
#kable(indvalsummary1)

indvalsummary1 <- cbind(rownames(indvalsummary1), data.frame(indvalsummary1, row.names=NULL))

names(indvalsummary1)[1]<-"species"

indval <- left_join(indvalsummary1, plant_names, by = "species") %>% 
  mutate(HS_ind = ifelse(is.na(full_name), species, full_name)) %>% 
  dplyr::select(HS_ind, group, indval, pvalue) %>% 
  mutate("Indicator value" = indval * 100) %>% 
  filter(indval >= 0.25) %>% 
  filter(pvalue < 0.1)

indval_hs <- indval %>% 
  filter(group =="1") %>% 
  dplyr::select(HS_ind, "Indicator value")

indval_ls <- indval %>% 
  filter(group =="2")%>% 
  dplyr::select(HS_ind, "Indicator value")

names(indval_hs)[1]<-"Indicators of HS"
names(indval_ls)[1]<-"Indicators of LS/UN"


#names(spp_diff2)[1]<-"Species found only in LS/UN"
indval_table <- list(indval_hs, indval_ls)

kable(indval_table, caption = "Table 3: Indicator species for different habitats (HS vs LS/UN)", digits = 0) %>%
  kable_styling()

#write.csv(indvalsummary1, file = "indvalsummary1.csv")
#write.csv(prob.corrected1, file = "prob.corrected1.csv")
```

# Species frequency of occurrence in each habitat
* Looking at the fequency of occurrence of all plants detected at least 5 times (114 species), it appears that most species that have a preference for UN/LS or HS are also found in MANAG sites: 20/27 species found at least 2x more frequently in UNLS as in HS are also found at least 2x more frequently in mult or Rx than HS. Conversely, 38/42 species that are at least 2x as frequent in HS as in UNLS are also 2x as frequent in either mult or Rx as in UN/LS.
*Kruskall-Wallis rank test?
```{r}
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type
plant_mat_UNLS <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "u" | sev == "l") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_HS <- plant_mat_pa_w %>% 
  left_join(site_data, by = "site_id") %>% 
  filter(sev=="h") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MANAG <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "multiple" | sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MULT <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "multiple") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_Rx <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

#Getting the number of detections for each species
plant_dat_sum_HS <- rbind(plant_mat_HS[,-1], colSums(plant_mat_HS[-1,-1]))
plant_sum_HS <- data.frame(t(tail(plant_dat_sum_HS, n = 1))) # keep only last row (sum) and transpose
plant_sum_HS <- cbind(rownames(plant_sum_HS), data.frame(plant_sum_HS, row.names=NULL)) # row names to column
colnames(plant_sum_HS) <- c("species", "sum")

plant_dat_sum_UNLS <- rbind(plant_mat_UNLS[,-1], colSums(plant_mat_UNLS[-1,-1]))
plant_sum_UNLS <- data.frame(t(tail(plant_dat_sum_UNLS, n= 1))) 
plant_sum_UNLS <- cbind(rownames(plant_sum_UNLS), data.frame(plant_sum_UNLS, row.names=NULL))
colnames(plant_sum_UNLS) <- c("species", "sum")

plant_dat_sum_MANAG <- rbind(plant_mat_MANAG[,-1], colSums(plant_mat_MANAG[-1,-1]))
plant_sum_MANAG <- data.frame(t(tail(plant_dat_sum_MANAG, n = 1))) 
plant_sum_MANAG <- cbind(rownames(plant_sum_MANAG), data.frame(plant_sum_MANAG, row.names=NULL))
colnames(plant_sum_MANAG) <- c("species", "sum")

plant_dat_sum_MULT <- rbind(plant_mat_MULT[,-1], colSums(plant_mat_MULT[-1,-1]))
plant_sum_MULT <- data.frame(t(tail(plant_dat_sum_MULT, n = 1))) 
plant_sum_MULT <- cbind(rownames(plant_sum_MULT), data.frame(plant_sum_MULT, row.names=NULL))
colnames(plant_sum_MULT) <- c("species", "sum")

plant_dat_sum_Rx <- rbind(plant_mat_Rx[,-1], colSums(plant_mat_Rx[-1,-1]))
plant_sum_Rx <- data.frame(t(tail(plant_dat_sum_Rx, n = 1))) 
plant_sum_Rx <- cbind(rownames(plant_sum_Rx), data.frame(plant_sum_Rx, row.names=NULL))
colnames(plant_sum_Rx) <- c("species", "sum")

plant_dat_sum <- plant_sum_UNLS %>% 
  left_join(plant_sum_HS, by = "species") %>% 
  left_join(plant_sum_MANAG, by = "species") %>% 
  left_join(plant_sum_MULT, by = "species") %>% 
  left_join(plant_sum_Rx, by = "species")

colnames(plant_dat_sum) <- c("species", "det_UNLS", "det_HS", "det_MANAG", "det_MULT", "det_Rx")
plant_dat_sum[is.na(plant_dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
plant_dat_percent <- plant_dat_sum %>% 
  mutate(., UNLS_occ = (det_UNLS/(nrow(plant_dat_sum_UNLS) -1)*100)) %>% 
  mutate(., HS_occ = (det_HS/(nrow(plant_dat_sum_HS) -1)*100)) %>% 
  mutate(., MANAG_occ = (det_MANAG/(nrow(plant_dat_sum_MANAG) -1)*100)) %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(plant_dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(plant_dat_sum_Rx) -1)*100))%>% 
  mutate(., total_occ = (det_UNLS + det_HS + det_MANAG + det_MULT + det_Rx)) %>% 
  filter(total_occ >5)  # keep only species detected more than 5 times

print_occ_table <- plant_dat_percent[, -c(2:6)]

write.csv(print_occ_table, file = "output/print_occ_table_all.csv")

```

```{r}
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type
mat_UNLS <- all_spp_dat_w %>%
  filter(sev == "u" | sev == "l") %>% 
  dplyr::select(ABCO:YRWA)

mat_HS <- all_spp_dat_w %>% 
  filter(sev=="h") %>% 
  dplyr::select(ABCO:YRWA)

mat_MANAG <- all_spp_dat_w %>%
  filter(sev == "multiple" | sev == "Rx") %>% 
  dplyr::select(ABCO:YRWA)

mat_MULT <- all_spp_dat_w %>%
  filter(sev == "multiple") %>% 
  dplyr::select(ABCO:YRWA)

mat_Rx <- all_spp_dat_w %>%
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YRWA)

#Getting the number of detections for each species
dat_sum_HS <- rbind(mat_HS[,-1], colSums(mat_HS[-1,-1]))
sum_HS <- data.frame(t(tail(dat_sum_HS, n = 1))) # keep only last row (sum) and transpose
sum_HS <- cbind(rownames(sum_HS), data.frame(sum_HS, row.names=NULL)) # row names to column
colnames(sum_HS) <- c("species", "sum")

dat_sum_UNLS <- rbind(mat_UNLS[,-1], colSums(mat_UNLS[-1,-1]))
sum_UNLS <- data.frame(t(tail(dat_sum_UNLS, n= 1))) 
sum_UNLS <- cbind(rownames(sum_UNLS), data.frame(sum_UNLS, row.names=NULL))
colnames(sum_UNLS) <- c("species", "sum")

dat_sum_MANAG <- rbind(mat_MANAG[,-1], colSums(mat_MANAG[-1,-1]))
sum_MANAG <- data.frame(t(tail(dat_sum_MANAG, n = 1))) 
sum_MANAG <- cbind(rownames(sum_MANAG), data.frame(sum_MANAG, row.names=NULL))
colnames(sum_MANAG) <- c("species", "sum")

dat_sum_MULT <- rbind(mat_MULT[,-1], colSums(mat_MULT[-1,-1]))
sum_MULT <- data.frame(t(tail(dat_sum_MULT, n = 1))) 
sum_MULT <- cbind(rownames(sum_MULT), data.frame(sum_MULT, row.names=NULL))
colnames(sum_MULT) <- c("species", "sum")

dat_sum_Rx <- rbind(mat_Rx[,-1], colSums(mat_Rx[-1,-1]))
sum_Rx <- data.frame(t(tail(dat_sum_Rx, n = 1))) 
sum_Rx <- cbind(rownames(sum_Rx), data.frame(sum_Rx, row.names=NULL))
colnames(sum_Rx) <- c("species", "sum")

dat_sum <- sum_UNLS %>% 
  left_join(sum_HS, by = "species") %>% 
  left_join(sum_MANAG, by = "species") %>% 
  left_join(sum_MULT, by = "species") %>% 
  left_join(sum_Rx, by = "species")

colnames(dat_sum) <- c("species", "det_UNLS", "det_HS", "det_MANAG", "det_MULT", "det_Rx")
dat_sum[is.na(dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
dat_percent <- dat_sum %>% 
  mutate(., UNLS_occ = (det_UNLS/(nrow(dat_sum_UNLS) -1)*100)) %>% 
  mutate(., HS_occ = (det_HS/(nrow(dat_sum_HS) -1)*100)) %>% 
  mutate(., MANAG_occ = (det_MANAG/(nrow(dat_sum_MANAG) -1)*100)) %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(dat_sum_Rx) -1)*100))%>% 
  mutate(., total_occ = (det_UNLS + det_HS + det_MULT + det_Rx)) %>% 
  filter(total_occ >5)  # keep only species detected more than 5 times

print_occ_table <- dat_percent[, -c(2:6)]

write.csv(print_occ_table, file = "output/print_occ_table_allspp2.csv")


sev <- c("H", "H", "H", "H", "LU", "LU", "LU", "LU")
hab <- c("total", "manag", "multiple", "Rx")
num <- c(51,46,46, 30, 42,31,22,28)
position <- c(1, 2, 3, 4, 1, 2, 4, 3)

prefs <- data.frame(sev, hab, num)

ggplot(prefs, aes(sev, num)) +
  geom_bar(aes(fill = hab, group = position), stat='identity', position="dodge") +  theme_cowplot(12)  + theme(aspect.ratio=1)  + 
scale_fill_manual("legend", values = c("total" = "midnightblue", "manag" = "sienna3", "Rx" = "darkorchid3", "multiple" = "cyan3"))+   xlab("preferred sev")  +
  ylab("number of species")

plot(curve_lu, col = "chartreuse4", ylim=c(0,90), ylab="species")
plot(curve_h, add = TRUE, col = "coral1") #col is COLOUR setting, so change it to something else if you want
plot(curve_multiple, add = TRUE, col = "cyan3")
plot(curve_Rx, add = TRUE, col = "darkorchid3")


  geom_col(position = )

?geom_col
  
  geom_bar(aes(weight = num)) +
  geom_bar(aes(fill=hab))


g <- ggplot(mpg, aes(class))
g + geom_bar()
g + geom_bar(aes(weight = displ))


```

```{r}
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type
plant_mat_Rx <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MULT <- plant_mat_pa_w %>% 
  left_join(site_data, by = "site_id") %>% 
  filter(sev=="multiple") %>% 
  dplyr::select(ABCO:YAMI)

#Getting the number of detections for each species
plant_dat_sum_MULT <- rbind(plant_mat_MULT[,-1], colSums(plant_mat_MULT[-1,-1]))
plant_sum_MULT <- data.frame(t(tail(plant_dat_sum_MULT, n = 1))) 
plant_sum_MULT <- cbind(rownames(plant_sum_MULT), data.frame(plant_sum_MULT, row.names=NULL))
colnames(plant_sum_MULT) <- c("species", "sum")

plant_dat_sum_Rx <- rbind(plant_mat_Rx[,-1], colSums(plant_mat_Rx[-1,-1]))
plant_sum_Rx <- data.frame(t(tail(plant_dat_sum_Rx, n = 1))) 
plant_sum_Rx <- cbind(rownames(plant_sum_Rx), data.frame(plant_sum_Rx, row.names=NULL))
colnames(plant_sum_Rx) <- c("species", "sum")

plant_dat_sum <- plant_sum_MULT %>% 
  left_join(plant_sum_Rx, by = "species")

colnames(plant_dat_sum) <- c("species", "det_MULT", "det_Rx")
plant_dat_sum[is.na(plant_dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
plant_dat_percent <- plant_dat_sum %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(plant_dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(plant_dat_sum_Rx) -1)*100))

print_occ_table <- plant_dat_percent[, -c(2:3)]

write.csv(print_occ_table, file = "output/print_occ_tab.csv")

```
