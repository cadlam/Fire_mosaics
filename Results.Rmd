---
title: "Results"
author: "Chris Adlam"
date: "2/11/2020"
output: html_document
---

# Results
```{r scripts_methods, include = F}
#source("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/scripts/splist2presabs.R") #function for going from species list to presence/absence
#source("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/scripts/pairwise_permanova.R")
#source("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/scripts/data_load.R") #contains packages to load
```

```{r canopy_cover, echo = F}
# could use this to calculate percent burnt in each sev category (3 is about 9.3%)
# But the problem with this calculation is that it isn't restricted to mixed evergreen forest... also it's fires that burnt in the WKRP area, but not the exact boundaries.
#fire_sev <- read.csv("/Users/christopheradlam/Desktop/Davis/R/GitHub Repos/Fire_mosaics/Data/fire_sev.csv")

#library(RColorBrewer)
#display.brewer.all(colorblindFriendly = T)
#display.brewer.pal(n = 4, name = 'Dark2')
#brewer.pal(n = 4, name = "Dark2")

cbp1 <- c("#1B9E77","#7570B3", "#E7298A", "#D95F02")

UNLS_col <- "#1B9E77"
Rx_col <- "#7570B3"
mult_col <- "#E7298A"
HS_col <- "#D95F02"

site_data$sev3 <- factor(site_data$sev3,levels = c("lu", "Rx", "multiple", "h"))

ggplot(site_data, aes(x = sev3, y = tree_cov)) +
  geom_boxplot(aes(fill=sev3)) +
  ggtitle("Fig.1: Canopy cover in each habitat") +
  ylab("canopy cover (%)")  +
  xlab("Habitat")  +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)
```

## Comparing community composition by habitat

### Effect of fire history on species composition
First, I take a look at which habitats have similar or different species composition, using a PERMANOVA. For all taxa, there is an effect of habitat (p < 0.001; main PERMANOVA not shown). 

```{r PERMANOVA_plants, echo = F}
### Is there an effect of sev and time since fire (using categories)? Yes for sev, no for tsf


#### Worth checking: there was an effect of tsf and an interaction using all plots incl. mult and Rx

# using on sites between 5 and 20 years old (and UN)

comp.data <- plant_dat_cov_w #%>%  #filter(sev %in% c("l", "h", "u"))
#    filter(sev == "multiple")

comp.sub <- subset(comp.data, select = ABCO:YAMI)
comp.env <- subset(comp.data, select = c(sev3, tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_plants <- kable(adonis2(log1p(comp.sub) ~ sev, permutations = 999), caption = "Table 1: PERMANOVA results (plants, cover)", digits = 5) %>%
  kable_styling()


## Pairwise PERMANOVA
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair_plants <- pairwise.adonis(log1p(comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_plants <- kable(pair_plants, caption = "Table 2: pairwise PERMANOVA results", digits = 5) %>%
  kable_styling()


```

```{r PERMANOVA_birds, echo = F}
#birds
comp.data <- bird_dat_w #%>%  #filter(sev %in% c("l", "h", "u"))
#  filter((tsf < 25 & tsf > 4) | sev == "u")# %>%
#  filter((sev == "multiple" & tree_cov > 45) | sev != "multiple")
  
comp.sub <- subset(comp.data, select = ACWO:YRWA)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_birds <- kable(adonis2(comp.sub ~ sev, permutations = 999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() 


## Pairwise PERMANOVA function (run)
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair_birds <- pairwise.adonis((comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_birds <- kable(pair_birds, caption = "Table 2: pairwise PERMANOVA results", digits = 4) %>%
  kable_styling()

```

```{r PERMANOVA_lichens, echo = F}
#lichens
comp.data <- lichen_dat_genus_pa_w #%>%  #filter(sev %in% c("l", "h", "u"))
#  filter((tsf < 25 & tsf > 4) | sev == "u")# %>%
#  filter((sev == "multiple" & tree_cov > 45) | sev != "multiple")
  
comp.sub <- subset(comp.data, select = Ahtiana:Xanthomendoza)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_lichens <- kable(adonis2(comp.sub ~ sev, permutations = 999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() 


## Pairwise PERMANOVA function (run)
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair_lichens <- pairwise.adonis((comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_lichens <- kable(pair_lichens, caption = "Table 2: pairwise PERMANOVA results", digits = 4) %>%
  kable_styling()
```

```{r PERMANOVA_all, echo = F}
#all spp
comp.data <- all_spp_dat_w #%>%  #filter(sev %in% c("l", "h", "u"))
#  filter((tsf < 25 & tsf > 4) | sev == "u")# %>%
#  filter((sev == "multiple" & tree_cov > 45) | sev != "multiple")
  
comp.sub <- subset(comp.data, select = ACMA:YRWA)
comp.env <- subset(comp.data, select = c(sev:tsf_cat))

sev <- comp.env$sev
#tsf <- comp.env$tsf_cat

PERMANOVA_sev_all <-kable(adonis2(comp.sub ~ sev, permutations = 999), caption = "Table 1: PERMANOVA results", digits = 5) %>%
  kable_styling() 


## Pairwise PERMANOVA function (run)
# 1 = High severity; 2 = Low severity; 3 = Unburnt; 4= multiple; 5 = Rx.
#comp.data <- comp.data %>% 
#    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", "3")))

# sev only, plant cover
comp.data1 <- comp.data %>% 
    mutate(sev2 = ifelse(sev == 'h' , "1", ifelse(sev == 'l' , "2", ifelse(sev == 'u', "3", ifelse(sev == 'multiple', "4", "5")))))

pair <- pairwise.adonis((comp.sub), comp.data1$sev2) %>% 
  dplyr::select(pairs, F.Model, p.adjusted)

pairwise_sev_all <- kable(pair, caption = "Table 2: pairwise PERMANOVA results", digits = 4) %>%
  kable_styling()


```


```{r all_pairwise_table, echo = F}
# Making a table of all pairwise comparisons
pairs <- c("HS vs LS", "LS vs MULT", "LS vs UN", "LS vs Rx", "HS vs MULT", "HS vs UN", "HS vs Rx", "MULT vs UN", "MULT vs Rx", "UN vs RX")
plants_F <-pair_plants$F.Model
plants_P <-pair_plants$p.adjusted
birds_F <-pair_birds$F.Model
birds_P <-pair_birds$p.adjusted
lichens_F <- pair_lichens$F.Model
lichens_P <-pair_lichens$p.adjusted

all_pairwise_table <- data.frame(pairs, plants_F, plants_P, birds_F, birds_P, lichens_F,lichens_P)

names(all_pairwise_table) <- c("Pair", "F_model", "p_adj", "F_model", "p_adj", "F_model", "p_adj")

all_pairwise_table <- all_pairwise_table[order(all_pairwise_table$Pair),]
rownames(all_pairwise_table) <- c()

kable(all_pairwise_table, digits = 3, caption = "Table 1: Pairwise PERMANOVA results") %>% 
  kable_styling("hover", full_width = F) %>%
  add_header_above(c(" ", "plants" = 2, "birds" = 2, "lichens" = 2))

```

### Pairwise habitat comparisons
Using pairwise PERMANOVAs to compare the habitats, there is no detectable difference between plant, bird or lichen communities of LS and UN habitat (Table 1) (plants: p = `r pair_plants[3,3]`; birds: p = `r pair_birds[3,3]` lichens: p = `r pair_lichens[3,3]`). For this reason, from here on I will lump unburnt stands and low severity burns together as UN/LS.

In addition, bird communities of HS and MULT are not detectably different (p = `r pair_plants[5,3]`). For lichens, the only habitat that stands out is the HS habitat (p < 0.02), although it is not statistically different from the MULT habitat (p = 1).

## Alpha, Beta, Gamma diversity patterns

Next I investigated the patterns of alpha, beta, and gamma diversity for birds and plants (lichens are not included; briefly, lichen species richness is highest in UN/LS, lowest in HS, and intermediate in the multiple and prescribed burns). The analysis here is based on presence/absence data, and does not account for relative abundance.

### Alpha diversity

Bird and plant species richness are highest in the prescribed and multiple burns, lower in the UN/LS and HS burns. Plant species richness is significantly higher in the HS burns than in the UN/LS stands. 

```{r echo = FALSE}
# First, make data frame with richness for each taxa at each site
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
all_richness <- ddply(all_spp_w_pa,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

all_div1 <- merge(all_richness, site_data, by = "site_id") 

# Birds
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
bird_richness <- ddply(bird_mat_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

bird_div1 <- merge(bird_richness, site_data, by = "site_id")

# Plants
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
plant_richness <- ddply(plant_mat_pa_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

plant_div1 <- merge(plant_richness, site_data, by = "site_id")

# Lichens
# species richness at each plot (from http://www.flutterbys.com.au/stats/tut/tut13.2.html)
lichen_richness <- ddply(lichen_mat_genus_pa_w,~site_id,function(x) {
   data.frame(richness=sum(x[-1]>0))
 })

lichen_div1 <- merge(lichen_richness, site_data, by = "site_id")
```

```{r echo = FALSE}
# Put it together
# richness tests
div <- all_div1 %>% dplyr::mutate(., rich_all = richness) %>% 
  dplyr::select(-richness) %>% 
  merge(., bird_div1[, c(1:2)], by = "site_id") %>% mutate(., rich_bird = richness) %>%
  dplyr::select(-richness) %>% 
  merge(., plant_div1[, c(1:2)], by = "site_id") %>% mutate(., rich_plant = richness) %>%
  dplyr::select(-richness) %>% 
  merge(., lichen_div1[, c(1:2)], by = "site_id") %>% mutate(., rich_lichen = richness) %>%
  dplyr::select(-richness)
```

```{r alpha_cld, include = FALSE}
# Now making the cld letters for the plots
#12/12/19
#  LU is statistically different (lower), RX is statistically different (higher); h is similar to lu and mult; mult is similar to h but separate from Rx (lu:a; h:ab; mult:b; Rx:c)
mod_add_all = lm(rich_all ~ sev3, data = div)
anova(mod_add_all)
means = emmeans(mod_add_all, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_all <- as.data.frame(cld(means$emmeans, Letters = letters))

#  LU is statistically different (lower), RX is statistically different (higher); h is similar to lu and mult; mult is similar to h and Rx (a; ab; bc; c)
mod_add_bird = lm(rich_bird ~ sev3, data = div)
anova(mod_add_bird)
means = emmeans(mod_add_bird, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_bird <- as.data.frame(cld(means$emmeans, Letters = letters))

#similar to bird pattern (lu: a, h: ab, mult:bc, Rx:c)
mod_add_plant = lm(rich_plant ~ sev3, data = div)
anova(mod_add_plant)
means = emmeans(mod_add_plant, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_plant <- as.data.frame(cld(means$emmeans, Letters = letters))

# LU is statistically different (higher), yet not different from Rx; h and mult are higher, though not diff from Rx. (h: a, mult: a, Rx: ab, lu:b)
mod_add_lichen = lm(rich_lichen ~ sev3, data = div)
anova(mod_add_lichen)
means = emmeans(mod_add_lichen, pairwise~sev3)
cld(means$emmeans, Letters = letters)
alpha_rich_stats_lichen <- as.data.frame(cld(means$emmeans, Letters = letters))
```


```{r all_alpha, echo = FALSE}
all_alpha <- ggplot(all_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("All spp richness") +
  xlab("Habitat")  +
  geom_text(aes(x = sev3, 
                y = emmean + 25),
            label = alpha_rich_stats_all$.group, 
            data = alpha_rich_stats_all) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```

```{r bird_alpha, echo = FALSE}
bird_alpha <- ggplot(bird_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("Bird richness") +
  xlab("Habitat")  +
  geom_text(aes(x = sev3, 
                y = emmean + 8),
            label = alpha_rich_stats_bird$.group, 
            data = alpha_rich_stats_bird) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```

```{r plant_alpha, echo = FALSE}
# p/a; cov is separate
plant_alpha <- ggplot(plant_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("Plant richness") +
  xlab("Habitat")  +
  geom_text(aes(x = sev3, 
                y = emmean + 22),
            label = alpha_rich_stats_plant$.group, 
            data = alpha_rich_stats_plant) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```

```{r lichen_alpha, echo = FALSE}
lich_alpha <- ggplot(lichen_div1, aes(x = sev3, y = richness, fill = sev3)) +
  geom_boxplot() +
  ggtitle("lichen richness") +
  xlab("Habitat")  +
  geom_text(aes(x = sev3, 
                y = emmean + 20),
            label = alpha_rich_stats_lichen$.group, 
            data = alpha_rich_stats_lichen) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)

```

```{r alpha_figures, echo = FALSE, fig.width=8, fig.height=6}
### All alpha plots
#(except insects)
grid.arrange(bird_alpha, plant_alpha, nrow = 1, bottom = "Fig.2: Plant and bird species richness")
```

### Beta Diversity

Beta diversity is highest in the prescribed and multiple burns; it is significantly higher in the HS burns than in the UN/LS stands.

```{r include = FALSE}
# Bionomial
# Code from Jonah

beta <- function(df){
  
  tempdf = df %>% dplyr::select(-sev3)
  
  dis = c(vegdist(tempdf, method = "binomial", binary = "true", na.rm = TRUE))
  
  result = data.frame(sev3 = rep(unique(df$sev3), length = length(dis)),
#                      year = rep(unique(df$year), length = length(dis)),
                      dis = dis)
  
}


#all spp
comptable <-  all_spp_w_pa %>% full_join(site_data[, c("site_id", "sev3")], by = "site_id") %>%
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(-c(site_id))

bj_output_all = comptable %>% group_by(sev3) %>% do(beta(.))



#birds
bird_dat_w$sev3 <- factor(bird_dat_w$sev3,levels = c("lu", "Rx", "multiple", "h"))
comptable <-  bird_dat_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ACWO:YRWA))

bj_output_birds = comptable %>% group_by(sev3) %>% do(beta(.))


#plants (pa)
plant_dat_pa_w$sev3 <- factor(plant_dat_pa_w$sev3,levels = c("lu", "Rx", "multiple", "h"))
comptable <-  plant_dat_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ABCO:YAMI)) 

bj_output_plants_pa = comptable %>% group_by(sev3) %>% do(beta(.))


#lichens (pa)
comptable <-  lichen_dat_genus_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, Ahtiana:Xanthomendoza)) %>% 
  dplyr::select(-Dummy)

bj_output_lichens = comptable %>% group_by(sev3) %>% do(beta(.))


```

```{r, include = FALSE}
#12/12/19
#  LU is statistically different (lower), RX is statistically different (higher); h is similar to lu and mult; mult is similar to h and Rx


#lu is stat lower; mult stat higher; h and Rx in between not diff
mod_add_all = lm(dis~ sev3, data = bj_output_all)
anova(mod_add_all)
means = emmeans(mod_add_all, pairwise~sev3)
all_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))

# mult and h are higher, not diff, then Rx, then lu
mod_add_bird = lm(dis~ sev3, data = bj_output_birds)
anova(mod_add_bird)
means = emmeans(mod_add_bird, pairwise~sev3)
bird_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))

# lu lowest, Rx highest (lu: a, h: ab, mult: bc, Rx: c)
mod_add_plant = lm(dis~ sev3, data = bj_output_plants_pa)
anova(mod_add_plant)
means = emmeans(mod_add_plant, pairwise~sev3)
plant_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))

# LU is statistically different (higher), but others are not
mod_add_lichen = lm(dis~ sev3, data = bj_output_lichens)
anova(mod_add_lichen)
means = emmeans(mod_add_lichen, pairwise~sev3)
lichen_beta_cld <- as.data.frame(cld(means$emmeans, Letters = letters))
```


```{r beta_figures, echo = FALSE, fig.width=8, fig.height=6}


beta_all <- bj_output_all %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("All spp Pairwise Beta Diversity")   +
  geom_text(aes(x = sev3, 
                y = 60),
            label = all_beta_cld$.group, 
            data = all_beta_cld) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)




beta_birds <- bj_output_birds %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Bird Pairwise Beta Diversity")   +
  geom_text(aes(x = sev3, 
                y = emmean + 7),
            label = bird_beta_cld$.group, 
            data = bird_beta_cld) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)


#plants (cov)
#remember to alter above function to use jaccard instead of binomial (and binary = false)
comptable <-  plant_dat_cov_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(c(sev3, ABCO:YAMI)) 

bj_output_plants_cov = comptable %>% group_by(sev3) %>% do(beta(.))

beta_plants_cov <- bj_output_plants_cov %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
  scale_fill_manual(values = cbp1) +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Plant Pairwise Beta Div. (jaccard)")   +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)



beta_plants_pa <- bj_output_plants_pa %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Plant Pairwise Beta Diversity")   +
  geom_text(aes(x = sev3, 
                y = emmean + 20),
            label = plant_beta_cld$.group, 
            data = plant_beta_cld) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)



beta_lichen_pa <- bj_output_lichens %>% ggplot(aes(x = sev3,
                         y = dis,
                         fill = sev3,
                         group = sev3)) +
  geom_boxplot() +
  #facet_wrap(~year) +
  xlab("Fire Severity") +
  ylab("beta div") +
#  ylim(0, 1) +
  #scale_fill_viridis_c(option = "magma") +
  ggtitle("Lichen Pairwise Beta Diversity")   +
  geom_text(aes(x = sev3, 
                y = 13),
            label = lichen_beta_cld$.group, 
            data = lichen_beta_cld) +
  scale_fill_manual(values = cbp1) +
  scale_x_discrete(breaks=c("h", "lu", "multiple", "Rx"),
                      labels=c("HS", "UN/LS", "MULT", "Rx")) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1)




# Putting plots together
grid.arrange(beta_birds, beta_plants_pa, nrow = 1, bottom = "Fig.3: Plant and bird beta diversity")
```

### Gamma diversity and rarefaction curves

I had a different number of samples in each habitat, so instead of presenting simple gamma diversity numbers which would be misleading, I am showing species accumulation curves. The pool of species appears largest in the multiple burns, lowest in the UN/LS stands, and intermediate in the HS burns. For birds, the species pool in the prescribed burn sites is also high, but for plants it levels out faster and is intermediate between the HS and UN/LS sites (however I want to caution against over-interpreting the Rx burn sites, because I had fewer plots and they were more gegraphically clustered).

```{r sp_acc_curves, echo = FALSE}
# need to use this to get the right colors, since the habitats are rearranged alphabetically in ggplot
cbp2 <- c("#D95F02", "#E7298A", "#7570B3", "#1B9E77")

#UNLS_col <- "#1B9E77"
#Rx_col <- "#7570B3"
#mult_col <- "#E7298A"
#HS_col <- "#D95F02"

# Species accumulation curves
# All SPP
all_spp_matrix <- merge(all_spp_w_pa, site_data, by = "site_id") %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,ABCO:YRWA)


#subset each habitat into its own df
all_spp_matrix %>% filter(sev3 == "h") -> h
all_spp_matrix %>% filter(sev3 == "lu") -> lu
all_spp_matrix %>% filter(sev3 == "multiple") -> multiple
all_spp_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "UN/LS")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")


# ggplot species accummulation curves
all_acc <- ggplot() +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h , colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = HS_col) +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = UNLS_col) +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = mult_col) +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = Rx_col) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("All Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species") 


# Birds
bird_matrix <- bird_dat_w %>% 
  #mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,ACWO:YRWA)

#subset each habitat into its own df
bird_matrix %>% filter(sev3 == "h") -> h
bird_matrix %>% filter(sev3 == "lu") -> lu
bird_matrix %>% filter(sev3 == "multiple") -> multiple
bird_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "UN/LS")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")

birds_acc <- ggplot() +
  scale_colour_manual(values=cbp2) +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = UNLS_col) +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = Rx_col) +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = mult_col) +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = HS_col) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("Bird Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species") 
  
# Plants
plant_matrix <- plant_dat_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,ABCO:YAMI)

#subset each habitat into its own df
plant_matrix %>% filter(sev3 == "h") -> h
plant_matrix %>% filter(sev3 == "lu") -> lu
plant_matrix %>% filter(sev3 == "multiple") -> multiple
plant_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "UN/LS")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")

plants_acc <- ggplot() +
  scale_colour_manual(values=cbp2) +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h , colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = HS_col) +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = UNLS_col) +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = mult_col) +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = Rx_col) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("Plant Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species") 
  
# Lichens
lichen_matrix <- lichen_dat_genus_pa_w %>% 
#  mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", sev)) %>% 
  dplyr::select(sev3,Ahtiana:Xanthomendoza)

#subset each habitat into its own df
lichen_matrix %>% filter(sev3 == "h") -> h
lichen_matrix %>% filter(sev3 == "lu") -> lu
lichen_matrix %>% filter(sev3 == "multiple") -> multiple
lichen_matrix %>% filter(sev3 == "Rx") -> Rx

#calc species accumulation curve for each habitat
curve_h = specaccum(h[, -1], method = "random")
curve_lu = specaccum(lu[, -1], method = "random")
curve_multiple = specaccum(multiple[, -1], method = "random")
curve_Rx = specaccum(Rx[, -1], method = "random")

#creating dataframes for ggplot2
data_h <- data.frame(Sites_h=curve_h$sites, Richness_h=curve_h$richness, SD_h=curve_h$sd) %>% mutate(sev = "HS")
data_lu <- data.frame(Sites_lu=curve_lu$sites, Richness_lu=curve_lu$richness, SD_lu=curve_lu$sd) %>% mutate(sev = "UN/LS")
data_mult <- data.frame(Sites_mult=curve_multiple$sites, Richness_mult=curve_multiple$richness, SD_mult=curve_multiple$sd) %>% mutate(sev = "Multiple")
data_Rx <- data.frame(Sites_Rx=curve_Rx$sites, Richness_Rx=curve_Rx$richness, SD_Rx=curve_Rx$sd) %>% mutate(sev = "Rx")

lichen_acc <- ggplot() +
  geom_point(data = data_h, aes(x=Sites_h, y=Richness_h, colour = sev)) +
  geom_line(data = data_h, aes(x=Sites_h, y=Richness_h , colour = sev)) +
  geom_ribbon(data = data_h ,aes(x=Sites_h, ymin=(Richness_h-2*SD_h),ymax=(Richness_h+2*SD_h)),alpha=0.2, fill = HS_col) +
  geom_point(data = data_lu, aes(x=Sites_lu, y=Richness_lu, colour = sev)) +
  geom_line(data = data_lu, aes(x=Sites_lu, y=Richness_lu , colour = sev)) +
  geom_ribbon(data  = data_lu, aes(x=Sites_lu, ymin=(Richness_lu-2*SD_lu),ymax=(Richness_lu+2*SD_lu)),alpha=0.2, fill = UNLS_col) +
  geom_point(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_line(data = data_mult, aes(x=Sites_mult, y=Richness_mult, colour = sev)) +
  geom_ribbon(data  = data_mult, aes(x=Sites_mult, ymin=(Richness_mult-2*SD_mult),ymax=(Richness_mult+2*SD_mult)),alpha=0.2, fill = mult_col) +
  geom_point(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_line(data = data_Rx, aes(x=Sites_Rx, y=Richness_Rx, colour = sev)) +
  geom_ribbon(data = data_Rx, aes(x=Sites_Rx, ymin=(Richness_Rx-2*SD_Rx),ymax=(Richness_Rx+2*SD_Rx)),alpha=0.2, fill = Rx_col) +
  theme_cowplot(12) + theme(legend.position = "none")  + theme(aspect.ratio=1) +
  ggtitle("Lichen Species Accumulation Curves") +
  xlab("# sites")  +
  ylab("# species")  

legend <- gtable_filter(ggplot_gtable(ggplot_build(plants_acc + theme(legend.position="right")+ theme(legend.title = element_blank()))), "guide-box")

  
sp_acc_plots <- grid.arrange(birds_acc, plants_acc, legend,
            # heights=c(1.1, 1.1, 0.1),
#            widths = c(2.5, 2.5, 0.5),
             widths = c(2.5, 2.5, 0.5),
             ncol = 3, nrow = 1, bottom = "Fig.4: Plant and bird species accumulation curves")

```

## Insect Indicator Species Analysis

Insect data was analyzed to the order or suborder level (and only for HS, LS and UN habitats). Six taxa were indicator species for the HS habitats. These are mainly pollinators (Aculeata (bees/stinging wasps), Brachyceran flies, Coleoptera), and herbivores (Homoptera, Heteroptera, Orthoptera), which probably reflects the higher abundance of flowers and broadleaf shrubs/trees in HS burns. 

```{r insect_indval,echo = F}
#12/11/19
insect_matrix <- insect_dat_w %>%   
  dplyr::select(c(site_id, sev, Aculeata:Thysanoptera)) %>% 
#  group_by(sev) %>% 
  #mutate(sev3 = ifelse(sev == "u" | sev == "l", "lu", ifelse(sev =="multiple", "h", sev))) %>%
  mutate(sev3 = ifelse(sev =="multiple", "h", ifelse(sev == "u" | sev == "l", "lu", sev)))
#  mutate(sev3 = ifelse(sev =="multiple", "h", sev))

### Vector for site classification
### severity
data <- insect_matrix %>% dplyr::select(c(Aculeata:Thysanoptera))
groups1 <- as.vector(insect_matrix$sev3)

Indval_out1 <- indval(data, groups1, numitr=10000)
gr <- Indval_out1$maxcls[Indval_out1$pval<=0.1]
iv <- Indval_out1$indcls[Indval_out1$pval<=0.1]
pv <- Indval_out1$pval[Indval_out1$pval<=0.1]
fr <- apply(data>0, 2, sum)[Indval_out1$pval<=0.1]
indvalsummary <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
indvalsummary1 <- indvalsummary[order(indvalsummary$group, -indvalsummary$indval),]
prob.corrected1 = p.adjust(Indval_out1$pval, "BH") # correct p.value for multiple testing
#kable(indvalsummary1)

indvalsummary1 <- cbind(rownames(indvalsummary1), data.frame(indvalsummary1, row.names=NULL))

names(indvalsummary1)[1]<-"species"

indval <- left_join(indvalsummary1, plant_names, by = "species") %>% 
  mutate(HS_ind = ifelse(is.na(full_name), species, full_name)) %>% 
  dplyr::select(HS_ind, group, indval, pvalue) %>% 
  mutate("IndVal" = indval * 100) %>% 
  filter(indval >= 0.25) %>% 
  filter(pvalue < 0.1)

library(gtools)

indval_hs <- indval %>% 
  filter(group =="1") %>% 
  dplyr::select(HS_ind, "IndVal", pvalue) %>% 
  mutate(p = stars.pval(indval$pvalue)) %>% 
  dplyr::select(-pvalue)


#kable(indval_hs, caption = "Table 2: Insect indicator species for high severity burns", digits = 0,
#  col.names = c("(Sub)order",
#                           "IndVal",
#                           "p")) %>% 
#  column_spec(1, width = "20em", bold = TRUE) %>% 
#  kable_styling()
```

```{r insect_indval_alt, echo = F}
# This finds similar results to labdsv package. But if I let it use different combinations (eg. h+l, h+u, h+l+u), it finds higher indvals for some of those combinations. Troubling!
mat <- insect_matrix %>% dplyr::select(c(Aculeata:Thysanoptera))
grp <- as.vector(insect_matrix$sev3)

indval = multipatt(mat, grp, control = how(nperm=99), max.order=2, duleg = T)#restcomb = c(1,2,3,6)
ind_sum <- summary(indval, indvalcomp=F, alpha=0.1)
data.frame(ids=names(ind_sum), nums=ind_sum)


```


## Species community composition

```{r echo = FALSE}
#*Kruskall-Wallis rank test?
  
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type
plant_mat_UNLS <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "u" | sev == "l") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_HS <- plant_mat_pa_w %>% 
  left_join(site_data, by = "site_id") %>% 
  filter(sev=="h") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MANAG <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "multiple" | sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_MULT <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "multiple") %>% 
  dplyr::select(ABCO:YAMI)

plant_mat_Rx <- plant_mat_pa_w %>%
  left_join(site_data, by = "site_id") %>% 
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

#Getting the number of detections for each species
plant_dat_sum_HS <- rbind(plant_mat_HS[,-1], colSums(plant_mat_HS[-1,-1]))
plant_sum_HS <- data.frame(t(tail(plant_dat_sum_HS, n = 1))) # keep only last row (sum) and transpose
plant_sum_HS <- cbind(rownames(plant_sum_HS), data.frame(plant_sum_HS, row.names=NULL)) # row names to column
colnames(plant_sum_HS) <- c("species", "sum")

plant_dat_sum_UNLS <- rbind(plant_mat_UNLS[,-1], colSums(plant_mat_UNLS[-1,-1]))
plant_sum_UNLS <- data.frame(t(tail(plant_dat_sum_UNLS, n= 1))) 
plant_sum_UNLS <- cbind(rownames(plant_sum_UNLS), data.frame(plant_sum_UNLS, row.names=NULL))
colnames(plant_sum_UNLS) <- c("species", "sum")

plant_dat_sum_MANAG <- rbind(plant_mat_MANAG[,-1], colSums(plant_mat_MANAG[-1,-1]))
plant_sum_MANAG <- data.frame(t(tail(plant_dat_sum_MANAG, n = 1))) 
plant_sum_MANAG <- cbind(rownames(plant_sum_MANAG), data.frame(plant_sum_MANAG, row.names=NULL))
colnames(plant_sum_MANAG) <- c("species", "sum")

plant_dat_sum_MULT <- rbind(plant_mat_MULT[,-1], colSums(plant_mat_MULT[-1,-1]))
plant_sum_MULT <- data.frame(t(tail(plant_dat_sum_MULT, n = 1))) 
plant_sum_MULT <- cbind(rownames(plant_sum_MULT), data.frame(plant_sum_MULT, row.names=NULL))
colnames(plant_sum_MULT) <- c("species", "sum")

plant_dat_sum_Rx <- rbind(plant_mat_Rx[,-1], colSums(plant_mat_Rx[-1,-1]))
plant_sum_Rx <- data.frame(t(tail(plant_dat_sum_Rx, n = 1))) 
plant_sum_Rx <- cbind(rownames(plant_sum_Rx), data.frame(plant_sum_Rx, row.names=NULL))
colnames(plant_sum_Rx) <- c("species", "sum")

plant_dat_sum <- plant_sum_UNLS %>% 
  left_join(plant_sum_HS, by = "species") %>% 
  left_join(plant_sum_MANAG, by = "species") %>% 
  left_join(plant_sum_MULT, by = "species") %>% 
  left_join(plant_sum_Rx, by = "species")

colnames(plant_dat_sum) <- c("species", "det_UNLS", "det_HS", "det_MANAG", "det_MULT", "det_Rx")
plant_dat_sum[is.na(plant_dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
plant_dat_percent <- plant_dat_sum %>% 
  mutate(., UNLS_occ = (det_UNLS/(nrow(plant_dat_sum_UNLS) -1)*100)) %>% 
  mutate(., HS_occ = (det_HS/(nrow(plant_dat_sum_HS) -1)*100)) %>% 
#  mutate(., MANAG_occ = (det_MANAG/(nrow(plant_dat_sum_MANAG) -1)*100)) %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(plant_dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(plant_dat_sum_Rx) -1)*100))%>% 
  mutate(., total_occ = (det_UNLS + det_HS + det_MANAG + det_MULT + det_Rx)) %>% 
  filter(total_occ >5) %>% # keep only species detected more than 5 times
  dplyr::select(-total_occ)

print_occ_table <- plant_dat_percent[, -c(2:6)]

write.csv(print_occ_table, file = "output/print_occ_table_all.csv")

```

```{r bar_chart_all, echo = FALSE}
# For lichens, see WKRP_fire


# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type
mat_UNLS <- all_spp_dat_w %>%
  filter(sev == "u" | sev == "l") %>% 
  dplyr::select(ABCO:YRWA)

mat_HS <- all_spp_dat_w %>% 
  filter(sev=="h") %>% 
  dplyr::select(ABCO:YRWA)

mat_MANAG <- all_spp_dat_w %>%
  filter(sev == "multiple" | sev == "Rx") %>% 
  dplyr::select(ABCO:YRWA)

mat_MULT <- all_spp_dat_w %>%
  filter(sev == "multiple") %>% 
  dplyr::select(ABCO:YRWA)

mat_Rx <- all_spp_dat_w %>%
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YRWA)

#Getting the number of detections for each species
dat_sum_HS <- rbind(mat_HS[,-1], colSums(mat_HS[-1,-1]))
sum_HS <- data.frame(t(tail(dat_sum_HS, n = 1))) # keep only last row (sum) and transpose
sum_HS <- cbind(rownames(sum_HS), data.frame(sum_HS, row.names=NULL)) # row names to column
colnames(sum_HS) <- c("species", "sum")

dat_sum_UNLS <- rbind(mat_UNLS[,-1], colSums(mat_UNLS[-1,-1]))
sum_UNLS <- data.frame(t(tail(dat_sum_UNLS, n= 1))) 
sum_UNLS <- cbind(rownames(sum_UNLS), data.frame(sum_UNLS, row.names=NULL))
colnames(sum_UNLS) <- c("species", "sum")

dat_sum_MANAG <- rbind(mat_MANAG[,-1], colSums(mat_MANAG[-1,-1]))
sum_MANAG <- data.frame(t(tail(dat_sum_MANAG, n = 1))) 
sum_MANAG <- cbind(rownames(sum_MANAG), data.frame(sum_MANAG, row.names=NULL))
colnames(sum_MANAG) <- c("species", "sum")

dat_sum_MULT <- rbind(mat_MULT[,-1], colSums(mat_MULT[-1,-1]))
sum_MULT <- data.frame(t(tail(dat_sum_MULT, n = 1))) 
sum_MULT <- cbind(rownames(sum_MULT), data.frame(sum_MULT, row.names=NULL))
colnames(sum_MULT) <- c("species", "sum")

dat_sum_Rx <- rbind(mat_Rx[,-1], colSums(mat_Rx[-1,-1]))
sum_Rx <- data.frame(t(tail(dat_sum_Rx, n = 1))) 
sum_Rx <- cbind(rownames(sum_Rx), data.frame(sum_Rx, row.names=NULL))
colnames(sum_Rx) <- c("species", "sum")

dat_sum <- sum_UNLS %>% 
  left_join(sum_HS, by = "species") %>% 
  left_join(sum_MANAG, by = "species") %>% 
  left_join(sum_MULT, by = "species") %>% 
  left_join(sum_Rx, by = "species")

colnames(dat_sum) <- c("species", "det_UNLS", "det_HS", "det_MANAG", "det_MULT", "det_Rx")
dat_sum[is.na(dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
dat_percent <- dat_sum %>% 
  mutate(., UNLS_occ = (det_UNLS/(nrow(dat_sum_UNLS) -1)*100)) %>% 
  mutate(., HS_occ = (det_HS/(nrow(dat_sum_HS) -1)*100)) %>% 
  mutate(., MANAG_occ = (det_MANAG/(nrow(dat_sum_MANAG) -1)*100)) %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(dat_sum_Rx) -1)*100))%>% 
  mutate(., total_occ = (det_UNLS + det_HS + det_MULT + det_Rx)) %>% 
  filter(total_occ >5)  # keep only species detected more than 5 times

print_occ_table <- dat_percent[, -c(2:6)]

write.csv(print_occ_table, file = "output/print_occ_table_allspp2.csv")

# now trying to do it all in r
# Species that prefer UNLS
dat_percent1 <- dat_percent %>% 
  mutate(sev_ratio = UNLS_occ/HS_occ)

UNLS_pref <- dat_percent1 %>% 
  filter(sev_ratio >= 2) %>% 
  dplyr::count("species")

UNLS_pref_mult <- dat_percent1 %>%   
  mutate(mult_ratio = MULT_occ/HS_occ) %>% 
  filter(sev_ratio >= 2) %>% 
  filter(mult_ratio >= 2) %>%
  dplyr::count("species")
  
UNLS_pref_Rx <- dat_percent1 %>% 
  mutate(Rx_ratio = Rx_occ/HS_occ) %>% 
  filter(sev_ratio >= 2) %>% 
  filter(Rx_ratio >= 2) %>% 
  dplyr::count("species")

# Species that prefer HS
HS_pref <- dat_percent1 %>% 
  filter(sev_ratio <= 0.5) %>% 
  dplyr::count("species")

HS_pref_mult <- dat_percent1 %>% 
  mutate(mult_ratio = MULT_occ/UNLS_occ) %>% 
  filter(sev_ratio <= 0.5) %>% 
  filter(mult_ratio >= 2) %>% 
  dplyr::count("species")
  
HS_pref_Rx <- dat_percent1 %>% 
  mutate(Rx_ratio = Rx_occ/UNLS_occ) %>% 
  filter(sev_ratio <= 0.5) %>% 
  filter(Rx_ratio >= 2) %>% 
  dplyr::count("species")
  
sev <- c("HS", "HS", "HS", "UN/LS", "UN/LS", "UN/LS")
hab <- c("total", "multiple", "Rx")
num <- c(HS_pref$n,HS_pref_mult$n,HS_pref_Rx$n, UNLS_pref$n,UNLS_pref_mult$n,UNLS_pref_Rx$n)
position <- c(1, 2, 3, 1, 3, 2)

#This changes everytime there's a subtle change to the data
#sev <- c("H", "H", "H", "H", "LU", "LU", "LU", "LU")
#hab <- c("total", "manag", "multiple", "Rx")
#num <- c(51,46,46, 30, 42,31,22,28)
#position <- c(1, 2, 3, 4, 1, 2, 4, 3)

#sev <- c("HS", "HS", "HS", "UN/LS", "UN/LS", "UN/LS")
#hab <- c("total", "multiple", "Rx")
#num <- c(56,50,36, 35,21,24)
#position <- c(1, 2, 3, 1, 3, 2)

prefs <- data.frame(sev, hab, num)

prefs_all_HS <- prefs %>% dplyr::filter(sev == "HS")
prefs_all_UNLS <- prefs %>% dplyr::filter(sev == "UN/LS")

p_all_HS <- ggplot(prefs[-1,], aes(x = hab, y = num, width=1)) +
  geom_bar(aes(fill = hab), stat='identity', position="dodge") + 
  geom_hline(yintercept = prefs[1,3], linetype="dashed", color = "red") + 
  geom_text(aes(x=1.5, y=prefs[1,3]),label="species that favor high severity",vjust=(1.1), size=5, color = "red") +
#  geom_text(aes(x=1.5, y=prefs[1,3]),label="favor high severity",vjust=1.1, size=5, color = "red") +
#  geom_text(aes(x=1, y=20),label="also favor MULT",vjust=0, size=5) +
#  geom_text(aes(x=2, y=20),label="also favor RX",vjust=1, size=5) +
  scale_x_discrete(expand = c(0, 0), breaks=c("multiple","Rx"),
        labels=c("also favor MULT", "also favor Rx")) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = prefs[1,3], fill = "blue", alpha = .1, color = NA) +
  theme_cowplot(12)  +
  theme(aspect.ratio=1)  + 
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0, 0), limits = c(0,65)) +
  scale_fill_manual("legend", 
                    values = c("total" = "midnightblue", "Rx" = Rx_col, "multiple" = mult_col)) +   
  xlab("")  +
  ylab("#") +
  ggtitle("All species")

sev <- c("HS", "HS", "HS", "UN/LS", "UN/LS", "UN/LS")
hab <- c("total", "multiple", "Rx")
num <- c(HS_pref$n,HS_pref_mult$n,HS_pref_Rx$n, UNLS_pref$n,UNLS_pref_mult$n,UNLS_pref_Rx$n)
position <- c(1, 2, 3, 1, 3, 2)

prefs <- data.frame(sev, hab, num) %>% dplyr::filter(sev == "UN/LS")

p_all_UNLS <- ggplot(prefs[-1,], aes(x = hab, y = num, width=1)) +
  geom_bar(aes(fill = hab), stat='identity', position="dodge") + 
  geom_hline(yintercept = prefs[1,3], linetype="dashed", color = "red") + 
  geom_text(aes(x=1.5, y=prefs[1,3]),label="species that favor UN/LS",vjust=(-0.2), size=5, color = "red") +
#  geom_text(aes(x=1.5, y=prefs[1,3]),label="favor high severity",vjust=1.1, size=5, color = "red") +
#  geom_text(aes(x=1, y=20),label="also favor MULT",vjust=0, size=5) +
#  geom_text(aes(x=2, y=20),label="also favor RX",vjust=1, size=5) +
  scale_x_discrete(expand = c(0, 0), breaks=c("multiple","Rx"),
        labels=c("also favor MULT", "also favor Rx")) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = prefs[1,3], fill = "blue", alpha = .1, color = NA) +
  theme_cowplot(12)  +
  theme(aspect.ratio=1)  + 
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0, 0), limits = c(0,(prefs[1,3]+5))) +
  scale_fill_manual("legend", 
                    values = c("total" = "midnightblue", "Rx" = Rx_col, "multiple" = mult_col)) +   
  xlab("")  +
  ylab("#") +
  ggtitle("All species")

options(digits = 0)
```



```{r bar_chart_plants, echo = FALSE}
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type

mat_UNLS <- plant_dat_pa_w %>%
  filter(sev == "u" | sev == "l") %>% 
  dplyr::select(ABCO:YAMI)

mat_HS <- plant_dat_pa_w %>% 
  filter(sev=="h") %>% 
  dplyr::select(ABCO:YAMI)

mat_MANAG <- plant_dat_pa_w %>%
  filter(sev == "multiple" | sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

mat_MULT <- plant_dat_pa_w %>%
  filter(sev == "multiple") %>% 
  dplyr::select(ABCO:YAMI)

mat_Rx <- plant_dat_pa_w %>%
  filter(sev == "Rx") %>% 
  dplyr::select(ABCO:YAMI)

#Getting the number of detections for each species
dat_sum_HS <- rbind(mat_HS[,-1], colSums(mat_HS[-1,-1]))
sum_HS <- data.frame(t(tail(dat_sum_HS, n = 1))) # keep only last row (sum) and transpose
sum_HS <- cbind(rownames(sum_HS), data.frame(sum_HS, row.names=NULL)) # row names to column
colnames(sum_HS) <- c("species", "sum")

dat_sum_UNLS <- rbind(mat_UNLS[,-1], colSums(mat_UNLS[-1,-1]))
sum_UNLS <- data.frame(t(tail(dat_sum_UNLS, n= 1))) 
sum_UNLS <- cbind(rownames(sum_UNLS), data.frame(sum_UNLS, row.names=NULL))
colnames(sum_UNLS) <- c("species", "sum")

dat_sum_MANAG <- rbind(mat_MANAG[,-1], colSums(mat_MANAG[-1,-1]))
sum_MANAG <- data.frame(t(tail(dat_sum_MANAG, n = 1))) 
sum_MANAG <- cbind(rownames(sum_MANAG), data.frame(sum_MANAG, row.names=NULL))
colnames(sum_MANAG) <- c("species", "sum")

dat_sum_MULT <- rbind(mat_MULT[,-1], colSums(mat_MULT[-1,-1]))
sum_MULT <- data.frame(t(tail(dat_sum_MULT, n = 1))) 
sum_MULT <- cbind(rownames(sum_MULT), data.frame(sum_MULT, row.names=NULL))
colnames(sum_MULT) <- c("species", "sum")

dat_sum_Rx <- rbind(mat_Rx[,-1], colSums(mat_Rx[-1,-1]))
sum_Rx <- data.frame(t(tail(dat_sum_Rx, n = 1))) 
sum_Rx <- cbind(rownames(sum_Rx), data.frame(sum_Rx, row.names=NULL))
colnames(sum_Rx) <- c("species", "sum")

dat_sum <- sum_UNLS %>% 
  left_join(sum_HS, by = "species") %>% 
  left_join(sum_MANAG, by = "species") %>% 
  left_join(sum_MULT, by = "species") %>% 
  left_join(sum_Rx, by = "species")

colnames(dat_sum) <- c("species", "det_UNLS", "det_HS", "det_MANAG", "det_MULT", "det_Rx")
dat_sum[is.na(dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
plant_dat_percent <- dat_sum %>% 
  mutate(., UNLS_occ = (det_UNLS/(nrow(dat_sum_UNLS) -1)*100)) %>% 
  mutate(., HS_occ = (det_HS/(nrow(dat_sum_HS) -1)*100)) %>% 
  mutate(., MANAG_occ = (det_MANAG/(nrow(dat_sum_MANAG) -1)*100)) %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(dat_sum_Rx) -1)*100))%>% 
  mutate(., total_occ = (det_UNLS + det_HS + det_MULT + det_Rx)) %>% 
  filter(total_occ >5)  # keep only species detected more than 5 times

print_occ_table <- dat_percent[, -c(2:6)]

#write.csv(print_occ_table, file = "output/print_occ_table_allspp2.csv")

# now trying to do it all in r
# Species that prefer UNLS
dat_percent1 <- plant_dat_percent %>% 
  mutate(sev_ratio = UNLS_occ/HS_occ)

# summary table of plants that prefer HS and UNLS

plant_UNLS_pref <- dat_percent1 %>% 
  filter(sev_ratio >= 2) %>% 
  dplyr::select(species) %>% 
  left_join(., plant_names, by = "species") %>% 
  mutate(species_name = ifelse(is.na(full_name), species, full_name)) %>% 
  dplyr::select(species_name) %>% 
  rename(prefer_UNLS = species_name) 

plant_HS_pref <- dat_percent1 %>% 
  filter(sev_ratio <= 0.5) %>% 
  dplyr::select(species) %>% 
  left_join(., plant_names, by = "species") %>% 
  mutate(species_name = ifelse(is.na(full_name), species, full_name)) %>% 
  dplyr::select(species_name) %>% 
  rename(prefer_HS = species_name)


#end data for summary table



UNLS_pref <- dat_percent1 %>% 
  filter(sev_ratio >= 2) %>% 
  dplyr::count("species")

UNLS_pref_mult <- dat_percent1 %>%   
  mutate(mult_ratio = MULT_occ/HS_occ) %>% 
  filter(sev_ratio >= 2) %>% 
  filter(mult_ratio >= 2) %>%
  dplyr::count("species")
  
UNLS_pref_Rx <- dat_percent1 %>% 
  mutate(Rx_ratio = Rx_occ/HS_occ) %>% 
  filter(sev_ratio >= 2) %>% 
  filter(Rx_ratio >= 2) %>% 
  dplyr::count("species")

# Species that prefer HS
HS_pref <- dat_percent1 %>% 
  filter(sev_ratio <= 0.5) %>% 
  dplyr::count("species")

HS_pref_mult <- dat_percent1 %>% 
  mutate(mult_ratio = MULT_occ/UNLS_occ) %>% 
  filter(sev_ratio <= 0.5) %>% 
  filter(mult_ratio >= 2) %>% 
  dplyr::count("species")
  
HS_pref_Rx <- dat_percent1 %>% 
  mutate(Rx_ratio = Rx_occ/UNLS_occ) %>% 
  filter(sev_ratio <= 0.5) %>% 
  filter(Rx_ratio >= 2) %>% 
  dplyr::count("species")
  
sev <- c("HS", "HS", "HS", "UN/LS", "UN/LS", "UN/LS")
hab <- c("total", "multiple", "Rx")
num <- c(HS_pref$n,HS_pref_mult$n,HS_pref_Rx$n, UNLS_pref$n,UNLS_pref_mult$n,UNLS_pref_Rx$n)
position <- c(1, 2, 3, 1, 3, 2)

#This changes everytime there's a subtle change to the data
#sev <- c("H", "H", "H", "H", "LU", "LU", "LU", "LU")
#hab <- c("total", "manag", "multiple", "Rx")
#num <- c(51,46,46, 30, 42,31,22,28)
#position <- c(1, 2, 3, 4, 1, 2, 4, 3)

#sev <- c("HS", "HS", "HS", "UN/LS", "UN/LS", "UN/LS")
#hab <- c("total", "multiple", "Rx")
#num <- c(56,50,36, 35,21,24)
#position <- c(1, 2, 3, 1, 3, 2)

prefs <- data.frame(sev, hab, num) 

prefs_plants_HS <- prefs %>% dplyr::filter(sev == "HS")
prefs_plants_UNLS <- prefs %>% dplyr::filter(sev == "UN/LS")

p_plants_HS <- ggplot(prefs_plants_HS[-1,], aes(x = hab, y = num, width=1)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = prefs_plants_HS[1,3], fill = HS_col, alpha = .5, color = NA) +
  geom_bar(aes(fill = hab), stat='identity', position="dodge") + 
  geom_hline(yintercept = prefs_plants_HS[1,3], linetype="solid", color = HS_col) + 
  geom_text(aes(x=1.5, y=prefs_plants_HS[1,3]),label="prefer HS",vjust=(-0.2), size=4, color = HS_col) +
#  geom_text(aes(x=1.5, y=prefs[1,3]),label="favor high severity",vjust=1.1, size=5, color = "red") +
#  geom_text(aes(x=1, y=20),label="also favor MULT",vjust=0, size=5) +
#  geom_text(aes(x=2, y=20),label="also favor RX",vjust=1, size=5) +
  scale_x_discrete(expand = c(0, 0), breaks=c("multiple","Rx"),
        labels=c("also favor\nMULT", "also favor\nRx")) +
  theme_cowplot(12)  +
  theme(aspect.ratio=1)  + 
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0, 0), limits = c(0,(1.2*prefs_plants_HS[1,3]))) +
  scale_fill_manual("legend", 
                    values = c("total" = "midnightblue", "Rx" = Rx_col, "multiple" = mult_col)) +   
#  theme(plot.title = element_text(size=22)) +
  xlab("")  +
  ylab("# species") +
  ggtitle("Plants")

p_plants_UNLS <- ggplot(prefs_plants_UNLS[-1,], aes(x = hab, y = num, width=1)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = prefs_plants_UNLS[1,3], fill = UNLS_col, alpha = 0.5, color = NA) +
  geom_bar(aes(fill = hab), stat='identity', position="dodge") + 
  geom_hline(yintercept = prefs_plants_UNLS[1,3], linetype="solid", color = UNLS_col) + 
  geom_text(aes(x=1.5, y=prefs_plants_UNLS[1,3]),label="prefer UN/LS",vjust=(-0.2), size=4, color = UNLS_col) +
#  geom_text(aes(x=1.5, y=prefs[1,3]),label="favor high severity",vjust=1.1, size=5, color = "red") +
#  geom_text(aes(x=1, y=20),label="also favor MULT",vjust=0, size=5) +
#  geom_text(aes(x=2, y=20),label="also favor RX",vjust=1, size=5) +
  scale_x_discrete(expand = c(0, 0), breaks=c("multiple","Rx"),
        labels=c("also favor\nMULT", "also favor\nRx")) +
  theme_cowplot(12)  +
  theme(aspect.ratio=1)  + 
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0, 0), limits = c(0,(1.2*prefs_plants_HS[1,3]))) +
  scale_fill_manual("legend", 
                    values = c("total" = "midnightblue", "Rx" = Rx_col, "multiple" = mult_col)) +   
  xlab("")  +
  ylab("# species") +
  ggtitle("Plants")

options(digits = 0)
```

```{r bar_chart_birds, echo = FALSE}
# This chunk is about comparing the frequency of different species in each habitat (see Wayman 2007)
## Let's look at UN/LS vs HS vs mult/Rx

# Calculating the number of occurrences in each trt
# First get the data matrices for each habitat type

mat_UNLS <- bird_dat_w %>%
  filter(sev == "u" | sev == "l") %>% 
  dplyr::select(ACWO:YRWA)

mat_HS <- bird_dat_w %>% 
  filter(sev=="h") %>% 
  dplyr::select(ACWO:YRWA)

mat_MANAG <- bird_dat_w %>%
  filter(sev == "multiple" | sev == "Rx") %>% 
  dplyr::select(ACWO:YRWA)

mat_MULT <- bird_dat_w %>%
  filter(sev == "multiple") %>% 
  dplyr::select(ACWO:YRWA)

mat_Rx <- bird_dat_w %>%
  filter(sev == "Rx") %>% 
  dplyr::select(ACWO:YRWA)

#Getting the number of detections for each species
dat_sum_HS <- rbind(mat_HS[,-1], colSums(mat_HS[-1,-1]))
sum_HS <- data.frame(t(tail(dat_sum_HS, n = 1))) # keep only last row (sum) and transpose
sum_HS <- cbind(rownames(sum_HS), data.frame(sum_HS, row.names=NULL)) # row names to column
colnames(sum_HS) <- c("species", "sum")

dat_sum_UNLS <- rbind(mat_UNLS[,-1], colSums(mat_UNLS[-1,-1]))
sum_UNLS <- data.frame(t(tail(dat_sum_UNLS, n= 1))) 
sum_UNLS <- cbind(rownames(sum_UNLS), data.frame(sum_UNLS, row.names=NULL))
colnames(sum_UNLS) <- c("species", "sum")

dat_sum_MANAG <- rbind(mat_MANAG[,-1], colSums(mat_MANAG[-1,-1]))
sum_MANAG <- data.frame(t(tail(dat_sum_MANAG, n = 1))) 
sum_MANAG <- cbind(rownames(sum_MANAG), data.frame(sum_MANAG, row.names=NULL))
colnames(sum_MANAG) <- c("species", "sum")

dat_sum_MULT <- rbind(mat_MULT[,-1], colSums(mat_MULT[-1,-1]))
sum_MULT <- data.frame(t(tail(dat_sum_MULT, n = 1))) 
sum_MULT <- cbind(rownames(sum_MULT), data.frame(sum_MULT, row.names=NULL))
colnames(sum_MULT) <- c("species", "sum")

dat_sum_Rx <- rbind(mat_Rx[,-1], colSums(mat_Rx[-1,-1]))
sum_Rx <- data.frame(t(tail(dat_sum_Rx, n = 1))) 
sum_Rx <- cbind(rownames(sum_Rx), data.frame(sum_Rx, row.names=NULL))
colnames(sum_Rx) <- c("species", "sum")

dat_sum <- sum_UNLS %>% 
  left_join(sum_HS, by = "species") %>% 
  left_join(sum_MANAG, by = "species") %>% 
  left_join(sum_MULT, by = "species") %>% 
  left_join(sum_Rx, by = "species")

colnames(dat_sum) <- c("species", "det_UNLS", "det_HS", "det_MANAG", "det_MULT", "det_Rx")
dat_sum[is.na(dat_sum)] <- 0

# Now dividing number of detections by number of sites and turning into %
bird_dat_percent <- dat_sum %>% 
  mutate(., UNLS_occ = (det_UNLS/(nrow(dat_sum_UNLS) -1)*100)) %>% 
  mutate(., HS_occ = (det_HS/(nrow(dat_sum_HS) -1)*100)) %>% 
  mutate(., MANAG_occ = (det_MANAG/(nrow(dat_sum_MANAG) -1)*100)) %>% 
  mutate(., MULT_occ = (det_MULT/(nrow(dat_sum_MULT) -1)*100)) %>% 
  mutate(., Rx_occ = (det_Rx/(nrow(dat_sum_Rx) -1)*100))%>% 
  mutate(., total_occ = (det_UNLS + det_HS + det_MULT + det_Rx)) %>% 
  filter(total_occ >5)  # keep only species detected more than 5 times

#print_occ_table <- dat_percent[, -c(2:6)]
#write.csv(print_occ_table, file = "output/print_occ_table_allspp2.csv")

# now trying to do it all in r
# Species that prefer UNLS
dat_percent1 <- bird_dat_percent %>% 
  mutate(sev_ratio = UNLS_occ/HS_occ)

# summary table of birds that prefer HS and UNLS
bird_UNLS_pref <- dat_percent1 %>% 
  filter(sev_ratio >= 2) %>% 
  dplyr::select(species) %>% 
  left_join(bird_names, by = "species") %>% 
  dplyr::select(Common.Name) %>% 
  rename(prefer_UNLS = Common.Name)

bird_HS_pref <- dat_percent1 %>% 
  filter(sev_ratio <= 0.5) %>% 
  dplyr::select(species) %>% 
  left_join(bird_names, by = "species") %>% 
  dplyr::select(Common.Name) %>% 
  rename(prefer_HS = Common.Name)

spp_diff_table <- list(plant_UNLS_pref, plant_HS_pref, bird_UNLS_pref, bird_HS_pref) 

#kable(spp_diff_table,
#      caption = "Plant (left two columns) and bird (right two columns) species summary, with habitat preference for UN/LS or HS") %>%
#  kable_styling("hover", full_width = F) #%>%
#  add_header_above(c("plants" = 2, "birds" = 2))

#kable(bird_names$Common.Name) %>%
#  kable_styling("hover", full_width = F) 


## end summary table
UNLS_pref <- dat_percent1 %>% 
  filter(sev_ratio >= 2) %>% 
  dplyr::count("species")



UNLS_pref_mult <- dat_percent1 %>%   
  mutate(mult_ratio = MULT_occ/HS_occ) %>% 
  filter(sev_ratio >= 2) %>% 
  filter(mult_ratio >= 2) %>%
  dplyr::count("species")
  
UNLS_pref_Rx <- dat_percent1 %>% 
  mutate(Rx_ratio = Rx_occ/HS_occ) %>% 
  filter(sev_ratio >= 2) %>% 
  filter(Rx_ratio >= 2) %>% 
  dplyr::count("species")

# Species that prefer HS
HS_pref <- dat_percent1 %>% 
  filter(sev_ratio <= 0.5) %>% 
  dplyr::count("species")

HS_pref_mult <- dat_percent1 %>% 
  mutate(mult_ratio = MULT_occ/UNLS_occ) %>% 
  filter(sev_ratio <= 0.5) %>% 
  filter(mult_ratio >= 2) %>% 
  dplyr::count("species")
  
HS_pref_Rx <- dat_percent1 %>% 
  mutate(Rx_ratio = Rx_occ/UNLS_occ) %>% 
  filter(sev_ratio <= 0.5) %>% 
  filter(Rx_ratio >= 2) %>% 
  dplyr::count("species")
  
sev <- c("HS", "HS", "HS", "UN/LS", "UN/LS", "UN/LS")
hab <- c("total", "multiple", "Rx")
num <- c(HS_pref$n,HS_pref_mult$n,HS_pref_Rx$n, UNLS_pref$n,UNLS_pref_mult$n,UNLS_pref_Rx$n)
position <- c(1, 2, 3, 1, 3, 2)

#This changes everytime there's a subtle change to the data
#sev <- c("H", "H", "H", "H", "LU", "LU", "LU", "LU")
#hab <- c("total", "manag", "multiple", "Rx")
#num <- c(51,46,46, 30, 42,31,22,28)
#position <- c(1, 2, 3, 4, 1, 2, 4, 3)

#sev <- c("HS", "HS", "HS", "UN/LS", "UN/LS", "UN/LS")
#hab <- c("total", "multiple", "Rx")
#num <- c(56,50,36, 35,21,24)
#position <- c(1, 2, 3, 1, 3, 2)

prefs <- data.frame(sev, hab, num)
  
prefs_birds_HS <- prefs %>% dplyr::filter(sev == "HS")
prefs_birds_UNLS <- prefs %>% dplyr::filter(sev == "UN/LS")

p_birds_HS <- ggplot(prefs_birds_HS[-1,], aes(x = hab, y = num, width=1)) +
   annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = prefs_birds_HS[1,3], fill = HS_col, alpha = .5, color = NA) +
  geom_bar(aes(fill = hab), stat='identity', position="dodge") + 
  geom_hline(yintercept = prefs_birds_HS[1,3], linetype="solid", color = HS_col) + 
  geom_text(aes(x=1.5, y=prefs_birds_HS[1,3]),label="prefer HS",vjust=(-0.2), size=4, color = HS_col) +
#  geom_text(aes(x=1.5, y=prefs[1,3]),label="favor high severity",vjust=1.1, size=5, color = "red") +
#  geom_text(aes(x=1, y=20),label="also favor MULT",vjust=0, size=5) +
#  geom_text(aes(x=2, y=20),label="also favor RX",vjust=1, size=5) +
  scale_x_discrete(expand = c(0, 0), breaks=c("multiple","Rx"),
        labels=c("also favor\nMULT", "also favor\nRx")) +
  theme_cowplot(12)  +
  theme(aspect.ratio=1)  + 
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0, 0), limits = c(0,(1.2*prefs_birds_HS[1,3]))) +
  scale_fill_manual("legend", 
                    values = c("total" = "midnightblue", "Rx" = Rx_col, "multiple" = mult_col)) + 
  xlab("")  +
  ylab("# species") +
#  theme(plot.title = element_text(size=22)) +
  ggtitle("Birds")

p_birds_UNLS <- ggplot(prefs_birds_UNLS[-1,], aes(x = hab, y = num, width=1)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = prefs_birds_UNLS[1,3], fill = UNLS_col, alpha = .5, color = NA) +
  geom_bar(aes(fill = hab), stat='identity', position="dodge") + 
  geom_hline(yintercept = prefs_birds_UNLS[1,3], color = UNLS_col) + 
#  geom_segment(aes(x=2.5, y=prefs_birds_UNLS[1,3]), xend = 0, yend = prefs_birds_UNLS[1,3]) +
  geom_text(aes(x=1.5, y=prefs_birds_UNLS[1,3]),label="prefer UN/LS",vjust=(-0.2), size=4, color = UNLS_col) +
#  geom_text(aes(x=1.5, y=prefs[1,3]),label="favor high severity",vjust=1.1, size=5, color = "red") +
#  geom_text(aes(x=1, y=20),label="also favor MULT",vjust=0, size=5) +
#  geom_text(aes(x=2, y=20),label="also favor RX",vjust=1, size=5) +
  scale_x_discrete(expand = c(0, 0), breaks=c("multiple","Rx"),
        labels=c("also favor\nMULT", "also favor\nRx")) +
  theme_cowplot(12)  +
  theme(aspect.ratio=1)  + 
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0, 0), limits = c(0,(1.2*prefs_birds_HS[1,3]))) +
  scale_fill_manual("legend", 
                    values = c("total" = "midnightblue", "Rx" = Rx_col, "multiple" = mult_col)) + 
  xlab("")  +
  ylab("# species") +
  ggtitle("Birds")

options(digits = 0)
```


Looking at the fequency of occurrence of all plant, bird, and lichen species detected at least 5 times (144 species), I identified species with a strong preference for HS sites or for UN/LS sites. Species were associated with each of these two cohorts if they were found at least twice as frequently in one habitat than in the other. For example, Achillea millefolium (Yarrow) was found in 19% of HS plots and 3% of UN/LS plots; therefore this species was classified as prefering HS stands. Then I determined if these species also favored MULT and/or Rx sites using the same rule. In this case, Achillea millefolium is found in 29%  of MULT plots and 28% of Rx plots; because this is also more than twice the UN/LS frequency (3%), I concluded this species also favors MULT and Rx sites.

I identified `r prefs_all_HS[1,3]` species (birds, plants and lichens combined) that seem to favor HS, and `r prefs_all_UNLS[1,3]` species that favor UN/LS. What I find is that most species that have a preference for UN/LS or HS are **also** found abundantly in MULT and/or Rx sites: `r prefs_all_UNLS[2,3]` species (`r prefs_all_UNLS[2,3]/prefs_all_UNLS[1,3]*100`%) prefering UN/LS also favor MULT, while `r prefs_all_UNLS[3,3]` (`r prefs_all_UNLS[3,3]/prefs_all_UNLS[1,3]*100`%) also favor Rx. Conversely, `r prefs_all_HS[2,3]` species (`r prefs_all_HS[2,3]/prefs_all_HS[1,3]*100`%) that prefer HS also favor MULT, and `r prefs_all_HS[3,3]` (`r prefs_all_HS[3,3]/prefs_all_HS[1,3]*100`%) also favor Rx.

Figure 5 breaks down the proportion of plants and birds that prefer HS or UN/LS that also favor MULT and Rx sites. 

```{r bar_plots, echo = F}
#grid.arrange(p_birds_HS, p_plants_HS, nrow=1)#, heights = c(21,21), widths = c(21,21))
#grid.arrange(p_birds_UNLS, p_plants_UNLS, nrow=1)

grid.arrange(p_birds_HS, p_plants_HS, p_birds_UNLS, p_plants_UNLS, nrow=2, bottom = "Fig. 5: Most species that prefer HS or UNLS also favor MULT and Rx")
```


